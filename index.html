<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>SafeVoice - Your Anonymous Voice Matters</title>
    <link rel="manifest" href="manifest.json">

    <style>
        /* ================================
        /* STYLES - v14.0
        /* ================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #334155; /* Slightly lighter for better contrast */
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 90px; /* Increased for bottom nav */
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: var(--surface);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .logo-icon { font-size: 36px; }

        .logo h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .tagline {
            color: var(--text-secondary);
            font-size: 14px;
            margin-top: 4px;
        }

        .stats {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .stat-item { flex: 1; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

        /* Crisis Banner */
        .crisis-banner {
            background: linear-gradient(135deg, var(--danger), #dc2626);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            animation: pulse 2s ease-in-out infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.9; } }

        .crisis-content { display: flex; align-items: center; gap: 16px; }
        .crisis-icon { font-size: 32px; }
        .crisis-text h3 { color: white; font-size: 18px; margin-bottom: 4px; }
        .crisis-text p { color: rgba(255, 255, 255, 0.9); font-size: 14px; }
        .crisis-button { background: white; color: var(--danger); padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 700; display: inline-block; margin-top: 12px; }

        /* Sections */
        .section { display: none; }
        .section.active { display: block; }

        /* Post Form */
        .post-form {
            background: var(--surface);
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary); }
        input, select, textarea { width: 100%; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 15px; font-family: inherit; }
        textarea { resize: vertical; min-height: 120px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }

        /* Button */
        .btn {
            background: linear-gradient(135deg, var(--primary), #8b5cf6);
            color: white; padding: 16px 32px; border: none; border-radius: 8px; cursor: pointer;
            font-size: 16px; font-weight: 700; width: 100%; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        /* Filters */
        .filters { display: flex; gap: 8px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 8px; }
        .filter-btn { padding: 10px 18px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; color: var(--text); cursor: pointer; white-space: nowrap; font-size: 14px; font-weight: 600; transition: all 0.2s; }
        .filter-btn.active { background: var(--primary); border-color: var(--primary); color: white; }

        /* Posts */
        .posts-container { display: flex; flex-direction: column; gap: 16px; }

        .post-card {
            background: var(--surface);
            padding: 24px;
            border-radius: 16px; /* Enhanced rounding */
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .post-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.3), 0 0 5px rgba(99, 102, 241, 0.5);
            border-color: rgba(99, 102, 241, 0.7);
        }

        .post-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; }
        .post-meta { font-size: 13px; color: var(--text-secondary); }
        .post-meta strong { color: var(--text); font-size: 15px; }
        .post-badge { padding: 6px 14px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .badge-mental { background: #8b5cf6; color: white; } .badge-academic { background: #3b82f6; color: white; } .badge-social { background: #10b981; color: white; } .badge-bullying { background: #ef4444; color: white; } .badge-other { background: #6b7280; color: white; } .badge-memorial { background: #f59e0b; color: white; }

        .post-content { margin: 16px 0; line-height: 1.8; font-size: 15px; white-space: pre-wrap; }
        .post-image { margin: 16px 0; border-radius: 8px; overflow: hidden; }
        .post-image img { width: 100%; display: block; }
        
        .post-footer {
            border-top: 1px solid var(--border);
            margin-top: 20px;
            padding-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .reactions { display: flex; gap: 10px; }
        .reaction-btn {
            padding: 10px 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px;
            cursor: pointer; font-size: 18px; transition: all 0.2s; text-align: center;
            display: flex; align-items: center; justify-content: center; gap: 6px; font-weight: 600;
        }
        .reaction-btn:hover { transform: scale(1.05); border-color: var(--primary); }
        .reaction-btn.reacted { background: var(--primary); border-color: var(--primary); color: white; }
        .reaction-count { font-size: 14px; }

        .comments-toggle-btn {
            background: none; border: 1px solid var(--border); color: var(--text-secondary);
            padding: 10px 16px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.2s;
        }
        .comments-toggle-btn:hover { background: var(--surface-light); color: var(--text); }
        
        /* Comments Section */
        .comments-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: none; /* Hidden by default */
        }
        .comments-list { display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto; padding-right: 8px; margin-bottom: 16px; }
        .comment { background: var(--bg); padding: 14px; border-radius: 8px; }
        .comment-meta { font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
        .comment-meta strong { color: var(--text); }
        .comment-content { font-size: 14px; }

        .comment-form { display: flex; gap: 10px; margin-top: 16px; }
        .comment-form textarea { min-height: 40px; height: 40px; }
        .comment-form button { padding: 0 20px; width: auto; font-size: 14px; }
        
        /* Helplines */
        .helplines-grid { display: grid; gap: 16px; }
        .helpline-card { background: var(--surface); padding: 20px; border-radius: 12px; border: 1px solid var(--border); }

        /* Profile Section */
        #profile .info-card { text-align: center; }
        #profile .stat-value { font-size: 48px; }
        #profile .stat-label { font-size: 16px; }
        #profile .user-id { font-size: 12px; color: var(--text-secondary); word-break: break-all; margin-top: 20px; background: var(--bg); padding: 10px; border-radius: 8px;}

        /* Loading & Empty States */
        .loading, .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .loading-spinner { font-size: 48px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .empty-state-icon { font-size: 72px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { font-size: 20px; margin-bottom: 8px; color: var(--text); }

        /* Toast */
        .toast {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.8); backdrop-filter: blur(10px); color: var(--text);
            padding: 16px 28px; border-radius: 12px; border: 1px solid var(--border);
            z-index: 1000; opacity: 0; transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); font-weight: 600;
        }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        /* Bottom Navigation */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(30, 41, 59, 0.7); /* Glassmorphism */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-around;
            padding: 12px 0; z-index: 100;
        }
        .bottom-nav-btn {
            flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px;
            background: none; border: none; color: var(--text-secondary); cursor: pointer;
            padding: 8px; font-size: 24px; transition: all 0.2s;
        }
        .bottom-nav-btn span { font-size: 11px; font-weight: 600; }
        .bottom-nav-btn.active { color: var(--primary); }

        /* Responsive */
        @media (max-width: 640px) {
            .container { padding: 12px; }
            .header, .post-form { padding: 20px; }
            .stats { gap: 12px; }
            .stat-value { font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo">
                <span class="logo-icon">üïäÔ∏è</span>
                <div>
                    <h1>SafeVoice</h1>
                    <p class="tagline">Your anonymous voice matters ‚Ä¢ Powered by community</p>
                </div>
            </div>
             <div class="stats">
                <div class="stat-item">
                    <div class="stat-value" id="totalPosts">0</div>
                    <div class="stat-label">Stories Shared</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalReactions">0</div>
                    <div class="stat-label">Support Given</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="totalComments">0</div>
                    <div class="stat-label">Comments</div>
                </div>
            </div>
        </div>

        <!-- Home Section -->
        <div id="home" class="section active">
            <!-- Post Form -->
            <div class="post-form">
                <h2 style="margin-bottom: 20px; font-size: 22px;">Share Anonymously</h2>
                <div class="form-group">
                    <label>Your College/University</label>
                    <input type="text" id="collegeInput" placeholder="e.g., IIT Kharagpur" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="categorySelect">
                        <option value="mental">üí≠ Mental Health</option>
                        <option value="academic">üìö Academic Pressure</option>
                        <option value="social">üë• Social Issues</option>
                        <option value="bullying">üö´ Bullying/Harassment</option>
                        <option value="other">üí¨ Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Your Story (Max 1000 characters)</label>
                    <textarea id="contentInput" maxlength="1000" placeholder="Share your story..."></textarea>
                </div>
                <button class="btn" id="postBtn" onclick="createPost()">
                    <span>üïäÔ∏è</span> Post Anonymously
                </button>
            </div>

            <!-- Filters -->
            <div class="filters" id="postFilters">
                <button class="filter-btn active" data-filter="all" onclick="filterPosts(this)">All Posts</button>
                <button class="filter-btn" data-filter="mental" onclick="filterPosts(this)">üí≠ Mental</button>
                <button class="filter-btn" data-filter="academic" onclick="filterPosts(this)">üìö Academic</button>
                <button class="filter-btn" data-filter="social" onclick="filterPosts(this)">üë• Social</button>
                <button class="filter-btn" data-filter="bullying" onclick="filterPosts(this)">üö´ Bullying</button>
            </div>

            <!-- Posts Container -->
            <div id="postsContainer" class="posts-container"></div>
        </div>

        <!-- Helplines Section -->
        <div id="helplines" class="section">
             <div class="crisis-banner">
                <div class="crisis-content">
                    <span class="crisis-icon">üÜò</span>
                    <div class="crisis-text">
                        <h3>Need Help Now?</h3>
                        <p>You're not alone. Help is available 24/7.</p>
                    </div>
                </div>
                <a href="tel:1860-2662-345" class="crisis-button">üìû Call Vandrevala Foundation</a>
            </div>
            <div class="helplines-grid">
                <!-- Helpline cards here -->
            </div>
        </div>

        <!-- Profile Section -->
        <div id="profile" class="section">
            <h2 style="margin-bottom: 24px; font-size: 26px;">Your Profile</h2>
            <div class="info-card">
                <div class="stat-value" id="userPostCount">...</div>
                <div class="stat-label">Your Anonymous Posts</div>
                <p class="user-id">Your anonymous ID: <strong id="userFingerprintId">...</strong></p>
                <p style="font-size: 14px; color: var(--text-secondary); margin-top: 16px;">This ID is unique to your browser and ensures your anonymity.</p>
            </div>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <button class="bottom-nav-btn active" onclick="switchSection('home', this)">
            <div>üè†</div> <span>Home</span>
        </button>
        <button class="bottom-nav-btn" onclick="switchSection('helplines', this)">
            <div>üìû</div> <span>Help</span>
        </button>
        <button class="bottom-nav-btn" onclick="switchSection('profile', this)">
            <div>üë§</div> <span>Profile</span>
        </button>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast"></div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ================================
        // CONFIGURATION - v14.0
        // ================================
        const SUPABASE_URL = 'https://jjfkwkmdvpxzjzbblodz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqZmt3a21kdnB4emp6YmJsb2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk0NzAwOTQsImV4cCI6MjA0NTA0NjA5NH0.rN8oDm5T_JXOG8KN_wBKiBdVTsE7OUOmBBkKJ4VF9TI';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let userFingerprint = localStorage.getItem('userFingerprint');
        if (!userFingerprint) {
            userFingerprint = `user_${Date.now().toString(36)}_${Math.random().toString(36).substring(2)}`;
            localStorage.setItem('userFingerprint', userFingerprint);
        }

        const ADJECTIVES = ['Brave', 'Strong', 'Hopeful', 'Kind', 'Wise', 'Calm', 'Proud', 'Valiant'];
        const NOUNS = ['Panda', 'Tiger', 'Eagle', 'Lion', 'Wolf', 'Bear', 'Fox', 'Hawk'];
        
        let currentFilter = 'all';

        // ================================
        // NAVIGATION
        // ================================
        function switchSection(sectionId, element) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');

            document.querySelectorAll('.bottom-nav-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            
            if (sectionId === 'profile') {
                loadProfileData();
            }
        }
        
        // ================================
        // POSTS
        // ================================
        async function createPost() {
            const college = document.getElementById('collegeInput').value.trim();
            const category = document.getElementById('categorySelect').value;
            const content = document.getElementById('contentInput').value.trim();

            if (!college || !content) { return showToast('‚ùå College and story cannot be empty.'); }

            const btn = document.getElementById('postBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span> Posting...';

            try {
                const anonymousId = generateAnonymousId();
                const { error } = await supabase.from('posts').insert([{ 
                    college, 
                    topic: category, // DB schema uses 'topic'
                    content, 
                    anonymous_id: anonymousId,
                    user_wallet: userFingerprint // Using this field for fingerprint
                }]);

                if (error) throw error;
                
                showToast('‚úÖ Post shared successfully!');
                document.getElementById('collegeInput').value = '';
                document.getElementById('contentInput').value = '';
                loadPostsAndStats();
            } catch (error) {
                console.error('Error creating post:', error);
                showToast(`‚ùå Error: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>üïäÔ∏è</span> Post Anonymously';
            }
        }

        async function loadPostsAndStats() {
            const container = document.getElementById('postsContainer');
            container.innerHTML = `<div class="loading"><div class="loading-spinner">üïäÔ∏è</div><p>Loading stories...</p></div>`;

            try {
                // Step 1: Fetch critical data (posts) first.
                // Switched to a specific select list to be more efficient and avoid potential column issues.
                const POST_COLUMNS = 'id, content, college, topic, anonymous_id, created_at';
                let postQuery = supabase.from('posts').select(POST_COLUMNS).order('created_at', { ascending: false });
                if (currentFilter !== 'all') {
                    postQuery = postQuery.eq('topic', currentFilter);
                }
                const { data: posts, error: postError } = await postQuery;

                if (postError) {
                    console.error('CRITICAL: Error fetching posts:', postError);
                    // This error is almost always due to Row Level Security (RLS) policies.
                    // Guide the user to the most likely solution.
                    throw new Error(`Could not fetch stories. Is RLS enabled on the 'posts' table? Ensure a policy exists for SELECT operations that returns 'true' for public access.`);
                }
                
                const postsData = posts || [];

                // Step 2: Fetch non-critical data (comments, reactions) safely.
                const [commentsResult, reactionsResult] = await Promise.allSettled([
                    supabase.from('comments').select('id, post_id', { count: 'exact' }),
                    supabase.from('reactions').select('id', { count: 'exact' })
                ]);
                
                const comments = commentsResult.status === 'fulfilled' ? (commentsResult.value.data || []) : [];
                const totalComments = commentsResult.status === 'fulfilled' ? (commentsResult.value.count || 0) : 0;
                if (commentsResult.status === 'rejected') {
                    console.warn('Could not fetch comments:', commentsResult.reason);
                }
                
                const totalReactions = reactionsResult.status === 'fulfilled' ? (reactionsResult.value.count || 0) : 0;
                 if (reactionsResult.status === 'rejected') {
                    console.warn('Could not fetch reactions:', reactionsResult.reason);
                }

                // Step 3: Render the UI with whatever data we have.
                const commentCounts = comments.reduce((acc, c) => {
                    acc[c.post_id] = (acc[c.post_id] || 0) + 1;
                    return acc;
                }, {});

                document.getElementById('totalPosts').textContent = postsData.length;
                document.getElementById('totalComments').textContent = totalComments;
                document.getElementById('totalReactions').textContent = totalReactions;
                
                if (postsData.length === 0) {
                    container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">üïäÔ∏è</div><h3>No stories yet</h3><p>Be the first to share your voice!</p></div>`;
                    return;
                }
                
                container.innerHTML = postsData.map(post => renderPost(post, commentCounts[post.id] || 0)).join('');

            } catch (error) {
                console.error('Error loading data:', error);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">‚ö†Ô∏è</div><h3>Error loading stories</h3><p>${error.message}</p></div>`;
            }
        }
        
        function filterPosts(element) {
            currentFilter = element.dataset.filter;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            loadPostsAndStats();
        }

        function renderPost(post, commentCount) {
            return `
                <div class="post-card" id="post-${post.id}">
                    <div class="post-header">
                        <div class="post-meta">
                            <strong>${escapeHtml(post.anonymous_id)}</strong> from <strong>${escapeHtml(post.college)}</strong><br>
                            <span>${getTimeAgo(post.created_at)}</span>
                        </div>
                        <span class="post-badge badge-${post.topic}">${post.topic}</span>
                    </div>
                    <div class="post-content">${escapeHtml(post.content)}</div>
                    <div class="post-footer">
                        <div class="reactions">
                            <button class="reaction-btn">üíö</button>
                            <button class="reaction-btn">‚ù§Ô∏è</button>
                            <button class="reaction-btn">üôå</button>
                        </div>
                        <button class="comments-toggle-btn" onclick="toggleComments('${post.id}')">
                            üí¨ Comments (<span id="comment-count-${post.id}">${commentCount}</span>)
                        </button>
                    </div>
                    <div class="comments-section" id="comments-${post.id}"></div>
                </div>
            `;
        }

        // ================================
        // COMMENTS
        // ================================
        async function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            const isVisible = commentsSection.style.display === 'block';

            if (isVisible) {
                commentsSection.style.display = 'none';
            } else {
                commentsSection.style.display = 'block';
                if (!commentsSection.innerHTML) {
                    loadComments(postId);
                }
            }
        }

        async function loadComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            commentsSection.innerHTML = `<div class="loading"><p>Loading comments...</p></div>`;

            try {
                const { data: comments, error } = await supabase
                    .from('comments')
                    .select('anonymous_id, content, created_at')
                    .eq('post_id', postId)
                    .order('created_at', { ascending: true });

                if (error) throw error;
                
                let commentsHtml = '<div class="comments-list">';
                if (comments.length > 0) {
                    commentsHtml += comments.map(renderComment).join('');
                } else {
                    commentsHtml += '<p>No comments yet. Be the first to reply!</p>';
                }
                commentsHtml += '</div>';

                commentsHtml += `
                    <form class="comment-form" onsubmit="createComment(event, '${postId}')">
                        <textarea required placeholder="Add a supportive comment..." maxlength="500"></textarea>
                        <button type="submit" class="btn">Reply</button>
                    </form>
                `;
                commentsSection.innerHTML = commentsHtml;
            } catch (error) {
                console.error('Error loading comments:', error);
                commentsSection.innerHTML = `<p>Error loading comments.</p>`;
            }
        }

        function renderComment(comment) {
            return `
                <div class="comment">
                    <div class="comment-meta">
                        <strong>${escapeHtml(comment.anonymous_id)}</strong>
                        <span>‚Ä¢ ${getTimeAgo(comment.created_at)}</span>
                    </div>
                    <p class="comment-content">${escapeHtml(comment.content)}</p>
                </div>
            `;
        }

        async function createComment(event, postId) {
            event.preventDefault();
            const form = event.target;
            const textarea = form.querySelector('textarea');
            const content = textarea.value.trim();

            if (!content) return;

            try {
                const anonymousId = generateAnonymousId();
                const { error } = await supabase
                    .from('comments')
                    .insert([{ post_id: postId, content, anonymous_id: anonymousId, user_wallet: userFingerprint }]);

                if (error) throw error;
                
                const countSpan = document.getElementById(`comment-count-${postId}`);
                countSpan.textContent = parseInt(countSpan.textContent) + 1;

                loadComments(postId); 
            } catch (error) {
                console.error('Error creating comment:', error);
                showToast('Failed to post comment.');
            }
        }

        // ================================
        // PROFILE
        // ================================
        async function loadProfileData() {
            document.getElementById('userFingerprintId').textContent = userFingerprint.substring(0, 15) + '...';
            const countEl = document.getElementById('userPostCount');
            countEl.textContent = '...';

            try {
                 const { count, error } = await supabase
                    .from('posts')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_wallet', userFingerprint);

                if (error) throw error;

                countEl.textContent = count;
            } catch (error) {
                console.error('Error fetching post count:', error);
                countEl.textContent = 'Error';
            }
        }
        
        // ================================
        // HELPERS
        // ================================
        function generateAnonymousId() {
            const adj = ADJECTIVES[Math.floor(Math.random() * ADJECTIVES.length)];
            const noun = NOUNS[Math.floor(Math.random() * NOUNS.length)];
            return `${adj} ${noun}`;
        }
        
        function getTimeAgo(timestamp) {
            const now = new Date();
            const secondsPast = (now.getTime() - new Date(timestamp).getTime()) / 1000;
            if (secondsPast < 60) return `${Math.round(secondsPast)}s ago`;
            if (secondsPast < 3600) return `${Math.round(secondsPast / 60)}m ago`;
            if (secondsPast <= 86400) return `${Math.round(secondsPast / 3600)}h ago`;
            const day = new Date(timestamp);
            return day.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        let toastTimeout;
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ================================
        // INITIALIZE APP
        // ================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üïäÔ∏è SafeVoice v14.0 Initialized');
            console.log(`‚úÖ Supabase connected. User Fingerprint: ${userFingerprint}`);
            loadPostsAndStats();
        });

    </script>
</body>
</html>


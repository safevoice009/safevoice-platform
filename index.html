<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SafeVoice v14.0 — Your Anonymous Voice Matters</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { background:#0f172a; color:#f1f5f9; font-family:sans-serif; margin:0; padding-bottom:100px; }
    .container { max-width:900px; margin:0 auto; padding:20px; }
    .card { background:rgba(30,41,59,0.7); border:1px solid #475569; border-radius:16px; padding:20px; margin-bottom:20px; }
    .btn { background:linear-gradient(135deg,#6366f1,#8b5cf6); color:white; border:none; border-radius:8px; padding:12px; font-weight:700; cursor:pointer; width:100%; }
    .reaction-btn { background:#1e293b; border:1px solid #475569; border-radius:8px; padding:8px 12px; cursor:pointer; margin:4px; }
    .comment-item { background:#334155; border-radius:8px; padding:8px; margin-top:6px; }
    .toast { position:fixed; bottom:100px; left:50%; transform:translateX(-50%); background:#1e293b; color:white; padding:12px 20px; border-radius:8px; opacity:0; transition:opacity 0.3s; }
    .toast.show { opacity:1; }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>🕊️ SafeVoice</h1>
      <p>Your anonymous voice matters • Powered by community</p>
      <div>
        <b id="totalPosts">0</b> Posts •
        <b id="totalReactions">0</b> Reactions •
        <b id="totalComments">0</b> Comments
      </div>
    </div>

    <div class="card">
      <h2>Share Anonymously</h2>
      <input id="collegeInput" placeholder="Your College/University" />
      <select id="topicSelect">
        <option value="mental">💭 Mental Health</option>
        <option value="academic">📚 Academic Pressure</option>
        <option value="social">👥 Social Issues</option>
        <option value="bullying">🚫 Bullying/Harassment</option>
        <option value="other">💬 Other</option>
      </select>
      <textarea id="contentInput" maxlength="1000" placeholder="Share your story..."></textarea>
      <div style="text-align:right;font-size:12px;"><span id="charCount">0</span>/1000</div>

      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="memorialToggle" /> 🕯️ This is a memorial tribute
      </label>
      <div id="memorialFields" style="display:none;">
        <input id="memorialName" placeholder="Name of the person (optional)" />
        <textarea id="memorialMessage" placeholder="Memorial message"></textarea>
      </div>

      <button class="btn" id="postBtn" onclick="createPost()">🕊️ Post Anonymously</button>
    </div>

    <div id="postsContainer">Loading posts...</div>
  </div>

  <div id="toast" class="toast"></div>
<script>
  // ================================
  // Supabase configuration
  // ================================
  const SUPABASE_URL = 'https://ytdlvsfhfyasisksrjyn.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl0ZGx2c2ZoZnlhc2lza3NyanluIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NzQ0NzMsImV4cCI6MjA3NjI1MDQ3M30.MB2EojydD3256h3EkjQzR1WsuUw1z2DTsFTLldjigZE';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Stable anonymous ID
  function getAnonymousId() {
    let id = localStorage.getItem('sv_anon_id');
    if (!id) {
      id = 'anon_' + Math.random().toString(36).slice(2);
      localStorage.setItem('sv_anon_id', id);
    }
    return id;
  }
  const anonymousId = getAnonymousId();

  // ================================
  // Helpers
  // ================================
  function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
  }
  function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  function timeAgo(iso) {
    const date = new Date(iso);
    const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
    const units = [['year',31536000],['month',2592000],['week',604800],['day',86400],['hour',3600],['minute',60]];
    for (const [label, size] of units) {
      const n = Math.floor(seconds / size);
      if (n >= 1) return `${n} ${label}${n!==1?'s':''} ago`;
    }
    return 'Just now';
  }

  // ================================
  // Create post
  // ================================
  async function createPost() {
    const college = document.getElementById('collegeInput').value.trim();
    const topic = document.getElementById('topicSelect').value;
    let content = document.getElementById('contentInput').value.trim();
    const isMemorial = document.getElementById('memorialToggle').checked;
    const memorialName = document.getElementById('memorialName').value.trim();
    const memorialMessage = document.getElementById('memorialMessage').value.trim();

    if (!college || !content) return showToast('❌ Fill all fields');

    let finalTopic = topic;
    if (isMemorial) {
      finalTopic = 'memorial';
      if (memorialName) content = `In Memory of ${memorialName}\n\n${content}`;
      if (memorialMessage) content += `\n\n${memorialMessage}`;
    }

    const { error } = await supabase.from('posts').insert([{
      college, topic: finalTopic, content,
      image_url: null, user_wallet: null,
      anonymous_id: anonymousId, created_at: new Date().toISOString()
    }]);
    if (error) { console.error(error); return showToast('❌ Error posting'); }

    showToast('✅ Posted');
    document.getElementById('collegeInput').value='';
    document.getElementById('contentInput').value='';
    document.getElementById('charCount').textContent='0';
    document.getElementById('memorialToggle').checked=false;
    document.getElementById('memorialFields').style.display='none';
    document.getElementById('memorialName').value='';
    document.getElementById('memorialMessage').value='';
    loadPosts();
  }

  // ================================
  // Load posts
  // ================================
  async function loadPosts() {
    const container = document.getElementById('postsContainer');
    container.innerHTML = 'Loading...';

    const { data: posts, error } = await supabase
      .from('posts')
      .select('*')
      .order('created_at',{ascending:false})
      .limit(20);

    if (error) { console.error(error); container.innerHTML='Error loading posts'; return; }
    if (!posts || posts.length===0) { container.innerHTML='No posts yet'; return; }

    const postIds = posts.map(p=>p.id);
    const { data: reactions } = await supabase.from('reactions').select('post_id,type').in('post_id', postIds);
    const { data: comments } = await supabase.from('comments').select('post_id,id').in('post_id', postIds);

    const reactionCounts={};
    (reactions||[]).forEach(r=>{
      reactionCounts[r.post_id]??={};
      reactionCounts[r.post_id][r.type]=(reactionCounts[r.post_id][r.type]||0)+1;
    });

    const commentCounts={};
    (comments||[]).forEach(c=>{
      commentCounts[c.post_id]=(commentCounts[c.post_id]||0)+1;
    });

    container.innerHTML = posts.map(p=>renderPost(p,reactionCounts[p.id]||{},commentCounts[p.id]||0)).join('');
  }

  // ================================
  // Render post
  // ================================
  function renderPost(post, counts, commentCount) {
    return `
      <div class="card">
        <h3>${escapeHtml(post.college)} • ${escapeHtml(post.topic)}</h3>
        <div style="font-size:12px;color:#94a3b8;">${timeAgo(post.created_at)}</div>
        <p>${escapeHtml(post.content)}</p>
        <div>
          <button class="reaction-btn" onclick="react('${post.id}','heart')">💖 ${counts.heart||0}</button>
          <button class="reaction-btn" onclick="react('${post.id}','support')">💚 ${counts.support||0}</button>
          <button class="reaction-btn" onclick="react('${post.id}','celebrate')">🎉 ${counts.celebrate||0}</button>
          <button class="reaction-btn" onclick="react('${post.id}','strong')">💪 ${counts.strong||0}</button>
          <button class="reaction-btn" onclick="react('${post.id}','fire')">🔥 ${counts.fire||0}</button>
          <button class="reaction-btn" onclick="react('${post.id}','sad')">😔 ${counts.sad||0}</button>
        </div>
        <div style="margin-top:10px;">
          <b>Comments (${commentCount})</b>
          <div id="comments-${post.id}"></div>
          <textarea id="comment-input-${post.id}" maxlength="500" placeholder="Write a comment..."></textarea>
          <button class="btn" onclick="addComment('${post.id}')">💬 Add Comment</button>
        </div>
      </div>
    `;
  }
  // ================================
  // Comments
  // ================================
  async function loadComments(postId) {
    const list = document.getElementById(`comments-${postId}`);
    if (!list) return;
    const { data, error } = await supabase
      .from('comments')
      .select('*')
      .eq('post_id', postId)
      .order('created_at',{ascending:true});
    if (error) { console.error(error); list.innerHTML='Error loading comments'; return; }
    if (!data || data.length===0) { list.innerHTML='<div class="comment-item">No comments yet</div>'; return; }
    list.innerHTML = data.map(c=>`
      <div class="comment-item">
        <div style="font-size:12px;color:#94a3b8;">${timeAgo(c.created_at)}</div>
        ${escapeHtml(c.content)}
      </div>
    `).join('');
  }

  async function addComment(postId) {
    const input = document.getElementById(`comment-input-${postId}`);
    const content = input.value.trim();
    if (!content) return showToast('❌ Write a comment');
    const { error } = await supabase.from('comments').insert([{
      post_id: postId, content,
      user_wallet: null, anonymous_id: anonymousId,
      created_at: new Date().toISOString()
    }]);
    if (error) { console.error(error); return showToast('❌ Error adding comment'); }
    input.value='';
    showToast('✅ Comment added');
    loadComments(postId);
  }

  // ================================
  // Reactions
  // ================================
  async function react(postId,type) {
    const { error } = await supabase.from('reactions').insert([{
      post_id: postId, type,
      user_wallet: null, anonymous_id: anonymousId,
      created_at: new Date().toISOString()
    }]);
    if (error) {
      if ((error.message||'').toLowerCase().includes('duplicate')) {
        return showToast('ℹ️ Already reacted');
      }
      console.error(error); return showToast('❌ Error reacting');
    }
    showToast('✅ Reaction added');
    loadPosts();
  }

  // ================================
  // Stats updater
  // ================================
  function updateStats() {
    const posts = document.querySelectorAll('.card');
    document.getElementById('totalPosts').textContent = posts.length;
    let reactions=0, comments=0;
    document.querySelectorAll('.reaction-btn').forEach(btn=>{
      const num = parseInt(btn.textContent.replace(/\D/g,''))||0;
      reactions+=num;
    });
    document.querySelectorAll('[id^="comments-"]').forEach(div=>{
      comments+=div.children.length;
    });
    document.getElementById('totalReactions').textContent = reactions;
    document.getElementById('totalComments').textContent = comments;
  }

  // ================================
  // Init
  // ================================
  window.addEventListener('load', ()=>{
    loadPosts();
  });
</script>
</body>
</html>

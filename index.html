<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>SafeVoice v14.1.0 - Rebuilt on v13.0</title> 
    <link rel="manifest" href="manifest.json">

    <style>
        /* ================================
         * CSS RESET & ROOT VARIABLES (From v13.0 Base)
         * ================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f1f5f9;
            --text-secondary: #94a3b8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border: #475569;
            
            /* v14 Feature: Glassmorphism Variables */
            --surface-glass-bg: rgba(30, 41, 59, 0.6);
            --border-glass: rgba(71, 85, 105, 0.5);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
            padding-bottom: 80px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ================================
         * v14 Feature: GLASSMORPHISM & UI UPGRADES
         * ================================ */
        .glassmorphism {
            background: var(--surface-glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-glass);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }

        /* ================================
         * HEADER & STATS (Apply Glassmorphism)
         * ================================ */
        .header {
            /* background: var(--surface); */ /* Replaced by glassmorphism */
            padding: 24px;
            border-radius: 16px;
            margin-bottom: 24px;
            /* border: 1px solid var(--border); */ /* Replaced by glassmorphism */
        }

        .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .logo-icon { font-size: 36px; }
        .logo h1 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, var(--primary), #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .tagline { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }
        .stats { display: flex; gap: 20px; margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); }
        .stat-item { flex: 1; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 12px; color: var(--text-secondary); margin-top: 4px; }

        /* ================================
         * CRISIS BANNER (Unchanged from v13.0)
         * ================================ */
        .crisis-banner { background: linear-gradient(135deg, var(--danger), #dc2626); padding: 20px; border-radius: 12px; margin-bottom: 24px; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.9; } }
        .crisis-content { display: flex; align-items: center; gap: 16px; }
        .crisis-icon { font-size: 32px; }
        .crisis-text h3 { color: white; font-size: 18px; margin-bottom: 4px; }
        .crisis-text p { color: rgba(255, 255, 255, 0.9); font-size: 14px; }
        .crisis-button { background: white; color: var(--danger); padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 700; display: inline-block; margin-top: 12px; }

        /* ================================
         * NAVIGATION & SECTIONS (v14 Update: Added Profile Button)
         * ================================ */
        .nav { display: flex; gap: 12px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 8px; }
        .nav-btn { padding: 12px 24px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; color: var(--text); cursor: pointer; white-space: nowrap; font-size: 14px; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; gap: 8px; }
        .nav-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .section { display: none; }
        .section.active { display: block; }

        /* ================================
         * MODAL (v14 Feature: For Posting & Comments)
         * ================================ */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); z-index: 1000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { width: 100%; max-width: 600px; padding: 24px; border-radius: 16px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-header h2 { font-size: 22px; }
        .modal-close-btn { font-size: 32px; font-weight: bold; color: var(--text-secondary); background: none; border: none; cursor: pointer; }

        /* ================================
         * POST FORM (v14 Update: Moved to Modal, apply Glassmorphism)
         * ================================ */
        .post-form { /* Styles moved to modal-content */ }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary); }
        input, select, textarea { width: 100%; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 15px; font-family: inherit; }
        textarea { resize: vertical; min-height: 120px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--primary); }
        .image-upload { display: flex; gap: 12px; margin-top: 12px; }
        .image-button { flex: 1; padding: 14px; background: var(--surface-light); border: 2px dashed var(--border); border-radius: 8px; cursor: pointer; text-align: center; font-size: 14px; font-weight: 600; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .image-button:hover { border-color: var(--primary); background: var(--primary); color: white; }
        .image-preview { margin-top: 12px; position: relative; }
        .image-preview img { max-width: 100%; border-radius: 8px; border: 1px solid var(--border); }
        .remove-image { position: absolute; top: 8px; right: 8px; background: var(--danger); color: white; border: none; border-radius: 50%; width: 36px; height: 36px; cursor: pointer; font-size: 20px; font-weight: bold; }
        .memorial-toggle { display: flex; align-items: center; gap: 12px; padding: 16px; background: var(--bg); border-radius: 8px; margin-top: 16px; border: 1px solid var(--border); }
        .memorial-toggle input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; }
        .memorial-toggle label { margin: 0; cursor: pointer; font-weight: 600; }
        .memorial-fields { margin-top: 16px; }
        .btn { background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; padding: 16px 32px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 700; width: 100%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

        /* ================================
         * FILTERS & POSTS (Apply Glassmorphism to Cards)
         * ================================ */
        .filters { display: flex; gap: 8px; margin-bottom: 24px; overflow-x: auto; padding-bottom: 8px; }
        .filter-btn { padding: 10px 18px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; color: var(--text); cursor: pointer; white-space: nowrap; font-size: 14px; font-weight: 600; transition: all 0.2s; }
        .filter-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        .posts-container { display: flex; flex-direction: column; gap: 16px; }
        .post-card { /* background: var(--surface); */ padding: 24px; border-radius: 12px; /* border: 1px solid var(--border); */ transition: all 0.3s ease; }
        .post-card:hover { transform: translateY(-4px); box-shadow: 0 0 20px rgba(99, 102, 241, 0.5); /* v14 Glow */ }
        .post-card.render-error { border: 1px dashed var(--danger); opacity: 0.7; padding: 15px; color: var(--danger); font-size: 14px; }
        .post-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; }
        .post-meta { font-size: 13px; color: var(--text-secondary); }
        .post-meta strong { color: var(--text); font-size: 15px; }
        .post-badge { padding: 6px 14px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .badge-mental { background: #8b5cf6; color: white; } .badge-academic { background: #3b82f6; color: white; } .badge-social { background: #10b981; color: white; } .badge-bullying { background: #ef4444; color: white; } .badge-other { background: #6b7280; color: white; } .badge-memorial { background: #f59e0b; color: white; }
        .post-content { margin: 16px 0; line-height: 1.8; font-size: 15px; white-space: pre-wrap; word-wrap: break-word; }
        .post-image { margin: 16px 0; border-radius: 8px; overflow: hidden; }
        .post-image img { width: 100%; display: block; }
        .memorial-tribute { background: linear-gradient(135deg, #f59e0b, #d97706); padding: 20px; border-radius: 8px; margin: 16px 0; color: white; }
        .memorial-tribute h4 { font-size: 16px; margin-bottom: 8px; }
        
        /* v14 Update: Post Actions container */
        .post-actions { display: flex; gap: 10px; margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px; min-height: 48px; align-items: center; }
        .reactions { display: flex; gap: 10px; flex-grow: 1; }
        .reaction-btn, .comment-btn { flex: 1; padding: 12px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 20px; transition: all 0.2s; text-align: center; display: flex; align-items: center; justify-content: center; gap: 6px; font-weight: 600; color: var(--text-secondary); }
        .comment-btn { flex: 0 1 auto; font-size: 14px; padding: 12px 16px; } /* v14 Comment Button */
        .reaction-btn:hover, .comment-btn:hover { transform: scale(1.05); border-color: var(--primary); color: var(--primary); }
        .reaction-btn.reacted { background: var(--primary); border-color: var(--primary); color: white; transform: scale(1.05); }
        .reaction-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .reaction-count { font-size: 14px; }

        /* ================================
         * v14 Feature: COMMENTS MODAL
         * ================================ */
        #commentsContainer { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; max-height: 40vh; overflow-y: auto; padding: 10px; background: var(--bg); border-radius: 8px; }
        .comment-card { background: var(--surface-light); padding: 16px; border-radius: 8px; border: 1px solid var(--border); }
        .comment-meta { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
        .comment-meta strong { color: var(--primary); }
        .comment-content { font-size: 15px; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; }
        .comment-card.render-error { border: 1px dashed var(--danger); opacity: 0.7; padding: 10px; color: var(--danger); font-size: 13px; }
        #commentForm { display: flex; gap: 10px; margin-top: 16px; }
        #commentInput { flex-grow: 1; min-height: 50px; resize: none; }
        #postCommentBtn { width: auto; padding: 12px 20px; font-size: 14px; }
        
        /* ================================
         * HELPLINES & COMMUNITY (Apply Glassmorphism)
         * ================================ */
        .helplines-grid, .community-grid { display: grid; gap: 16px; }
        .helpline-card, .info-card { /* background: var(--surface); */ padding: 20px; border-radius: 12px; /* border: 1px solid var(--border); */ }
        .helpline-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .helpline-icon { font-size: 32px; }
        .helpline-title { font-size: 18px; font-weight: 700; }
        .helpline-desc { color: var(--text-secondary); margin-bottom: 16px; line-height: 1.6; }
        .helpline-number { display: flex; align-items: center; justify-content: space-between; background: var(--bg); padding: 12px 16px; border-radius: 8px; margin-bottom: 8px; }
        .helpline-number strong { color: var(--primary); font-size: 18px; }
        .call-btn { background: var(--success); color: white; padding: 8px 16px; border-radius: 6px; text-decoration: none; font-weight: 600; font-size: 14px; }
        .helpline-hours { font-size: 13px; color: var(--text-secondary); margin-top: 8px; }
        .memorial-intro { background: linear-gradient(135deg, #f59e0b, #d97706); padding: 24px; border-radius: 12px; color: white; margin-bottom: 24px; text-align: center; }
        .memorial-intro h2 { font-size: 24px; margin-bottom: 8px; }
        .info-card h3 { font-size: 20px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; }
        .info-card p, .info-card li { color: var(--text-secondary); line-height: 1.8; }
        .info-card ul { list-style: none; margin-top: 12px; }
        .info-card li { padding: 8px 0; display: flex; align-items: start; gap: 8px; }
        .info-card li:before { content: "✓"; color: var(--success); font-weight: bold; }

        /* ================================
         * v14 Feature: PROFILE SECTION
         * ================================ */
        .profile-header { text-align: center; margin-bottom: 32px; }
        .profile-avatar { font-size: 80px; background: var(--surface-light); width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; border: 2px solid var(--primary); }
        .profile-id { font-size: 16px; color: var(--text-secondary); word-wrap: break-word; padding: 0 20px; }
        .profile-stats { display: flex; gap: 16px; justify-content: center; margin-top: 24px; }
        .profile-stat-item { padding: 20px; flex-basis: 150px; text-align: center; border-radius: 12px; }
        .profile-stat-value { font-size: 28px; font-weight: 700; color: var(--primary); }
        .profile-stat-label { font-size: 14px; color: var(--text-secondary); margin-top: 4px; }
        
        /* ================================
         * LOADING, EMPTY, TOAST (Unchanged from v13.0)
         * ================================ */
        .loading { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .loading-spinner { font-size: 48px; animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .empty-state { text-align: center; padding: 80px 20px; color: var(--text-secondary); }
        .empty-state-icon { font-size: 72px; margin-bottom: 16px; opacity: 0.5; }
        .empty-state h3 { font-size: 20px; margin-bottom: 8px; color: var(--text); }
        .toast { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: var(--surface); color: var(--text); padding: 16px 28px; border-radius: 12px; border: 1px solid var(--border); z-index: 1000; opacity: 0; transition: opacity 0.3s; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); font-weight: 600; }
        .toast.show { opacity: 1; }

        /* ================================
         * BOTTOM NAVIGATION (v14 Update: Layout & Glassmorphism)
         * ================================ */
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; /* background: var(--surface); */ /* border-top: 1px solid var(--border); */ border-top: 1px solid var(--border-glass); display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; }
        .bottom-nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; font-size: 24px; transition: all 0.2s; }
        .bottom-nav-btn span { font-size: 11px; font-weight: 600; }
        .bottom-nav-btn.active { color: var(--primary); }

        /* ================================
         * RESPONSIVE (Unchanged from v13.0, but check v14 elements)
         * ================================ */
        @media (max-width: 640px) {
            .container { padding: 12px; }
            .header { padding: 20px; }
            .modal-content { padding: 20px; max-height: 85vh; }
            #commentsContainer { max-height: 35vh; }
            .stats { gap: 12px; }
            .stat-value { font-size: 20px; }
            .crisis-content { flex-direction: column; text-align: center; }
            .image-upload { flex-direction: column; }
            .reactions { flex-wrap: wrap; }
            .profile-stats { flex-direction: column; } /* Stack profile stats on small screens */
            .profile-stat-item { flex-basis: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header glassmorphism">
            <div class="logo"> <span class="logo-icon">🕊️</span> <div> <h1>SafeVoice</h1> <p class="tagline">Your anonymous voice matters • Powered by community</p> </div> </div>
            <div class="stats">
                <div class="stat-item"> <div class="stat-value" id="totalPosts">0</div> <div class="stat-label">Stories Shared</div> </div>
                <div class="stat-item"> <div class="stat-value" id="totalReactions">0</div> <div class="stat-label">Support Given</div> </div>
                <div class="stat-item"> <div class="stat-value" id="totalMemorials">0</div> <div class="stat-label">Memorials</div> </div>
            </div>
        </div>

        <div class="crisis-banner">
            <div class="crisis-content"> <span class="crisis-icon">🆘</span> <div class="crisis-text"> <h3>Need Help Now?</h3> <p>You're not alone. Help is available now.</p> </div> </div>
            <a href="tel:1860-2662-345" class="crisis-button">📞 Call 1860-2662-345</a>
        </div>

        <div class="nav">
            <button class="nav-btn active" data-section="home" onclick="switchSection('home')">🏠 Home</button>
            <button class="nav-btn" data-section="helplines" onclick="switchSection('helplines')">📞 Helplines</button>
            <button class="nav-btn" data-section="memorials" onclick="switchSection('memorials')">🕯️ Memorials</button>
            <button class="nav-btn" data-section="community" onclick="switchSection('community')">👥 Community</button>
            <button class="nav-btn" data-section="profile" onclick="switchSection('profile')">👤 Profile</button>
        </div>

        <div id="home" class="section active">
            <div class="filters" id="postFilters">
                <button class="filter-btn active" onclick="filterPosts(event, 'all')">All Posts</button>
                <button class="filter-btn" onclick="filterPosts(event, 'mental')">💭 Mental Health</button>
                <button class="filter-btn" onclick="filterPosts(event, 'academic')">📚 Academic</button>
                <button class="filter-btn" onclick="filterPosts(event, 'social')">👥 Social</button>
                <button class="filter-btn" onclick="filterPosts(event, 'bullying')">🚫 Bullying</button>
            </div>
            <div id="postsContainer" class="posts-container">
                <div class="loading"> <div class="loading-spinner">🕊️</div> <p>Loading posts...</p> </div>
            </div>
        </div>

        <div id="helplines" class="section">
            <h2 style="margin-bottom: 24px; font-size: 26px;">🆘 Crisis Helplines</h2>
            <div class="helplines-grid">
                <div class="helpline-card glassmorphism"> <div class="helpline-header"> <span class="helpline-icon">💚</span> <div class="helpline-title">Vandrevala Foundation</div> </div> <p class="helpline-desc">24/7 • Mental health support & crisis intervention</p> <div class="helpline-number"> <strong>1860-2662-345</strong> <a href="tel:1860-2662-345" class="call-btn">📞 Call Now</a> </div> <div class="helpline-hours">Available 24/7 • Confidential</div> </div>
                <div class="helpline-card glassmorphism"> <div class="helpline-header"> <span class="helpline-icon">🆘</span> <div class="helpline-title">iCall - TISS</div> </div> <p class="helpline-desc">24/7 • Suicide prevention & counseling</p> <div class="helpline-number"> <strong>9152-987821</strong> <a href="tel:9152987821" class="call-btn">📞 Call Now</a> </div> <div class="helpline-hours">Monday-Saturday, 8 AM-10 PM</div> </div>
                <div class="helpline-card glassmorphism"> <div class="helpline-header"> <span class="helpline-icon">🧠</span> <div class="helpline-title">NIMHANS Helpline</div> </div> <p class="helpline-desc">Mon-Sat, 8 AM-10 PM • Professional counseling</p> <div class="helpline-number"> <strong>080-46110007</strong> <a href="tel:08046110007" class="call-btn">📞 Call Now</a> </div> <div class="helpline-hours">Expert mental health professionals</div> </div>
                 <div class="helpline-card glassmorphism"> <div class="helpline-header"> <span class="helpline-icon">🚨</span> <div class="helpline-title">Emergency Services</div> </div> <p class="helpline-desc">24/7 • Mental health emergency</p> <div class="helpline-number"> <strong>112</strong> <a href="tel:112" class="call-btn">📞 Call Now</a> </div> <div class="helpline-hours">National Emergency Number</div> </div>
            </div>
            <div class="info-card glassmorphism" style="margin-top: 24px;"> <h3>🔒 Your Privacy</h3> <p>All helplines maintain strict confidentiality. Your identity is protected when you call for help.</p> </div>
        </div>

        <div id="memorials" class="section">
            <div class="memorial-intro"> <h2>🕯️ In Loving Memory</h2> <p>Honoring those we've lost • Celebrating their lives</p> </div>
            <div id="memorialsContainer" class="posts-container">
                <div class="loading"> <div class="loading-spinner">🕯️</div> <p>Loading memorials...</p> </div>
            </div>
        </div>

        <div id="community" class="section">
            <h2 style="margin-bottom: 24px; font-size: 26px;">👥 Community Guidelines</h2>
            <div class="community-grid">
                <div class="info-card glassmorphism"> <h3>🕊️ Our Mission</h3> <p>SafeVoice provides a secure, anonymous platform...</p> </div>
                <div class="info-card glassmorphism"> <h3>🛡️ How We Protect You</h3> <ul> <li>Complete anonymity...</li> <li>No IP address tracking...</li> <li>Community-driven moderation...</li> </ul> </div>
                <div class="info-card glassmorphism"> <h3>❤️ Community Guidelines</h3> <ul> <li>Be kind and supportive...</li> <li>Respect others' experiences...</li> <li>No hate speech...</li> </ul> </div>
                 <div class="info-card glassmorphism"> <h3>💡 Get Involved</h3> <p>Help us build a supportive community...</p> </div>
            </div>
        </div>
        
        <div id="profile" class="section">
             <div class="profile-header"> <div class="profile-avatar">👤</div> <h2>Anonymous User</h2> <p class="profile-id" id="profileAnonId">Loading...</p> </div>
             <div class="profile-stats">
                <div class="profile-stat-item glassmorphism"> <div class="profile-stat-value" id="profilePostCount">0</div> <div class="profile-stat-label">Posts Created</div> </div>
                <div class="profile-stat-item glassmorphism"> <div class="profile-stat-value" id="profileReactionCount">0</div> <div class="profile-stat-label">Reactions Given</div> </div>
            </div>
        </div>

    </div> <div id="postModal" class="modal">
        <div class="modal-content glassmorphism">
            <div class="modal-header"> <h2>Share Anonymously</h2> <button class="modal-close-btn" onclick="closeModal('postModal')">&times;</button> </div>
            <div class="post-form">
                <div class="form-group"> <label>Your College/University</label> <input type="text" id="collegeInput" placeholder="e.g., IIT Kharagpur" required> </div>
                <div class="form-group"> <label>Category</label> <select id="categorySelect"> <option value="mental">💭 Mental Health</option> <option value="academic">📚 Academic Pressure</option> <option value="social">👥 Social Issues</option> <option value="bullying">🚫 Bullying/Harassment</option> <option value="other">💬 Other</option> </select> </div>
                <div class="form-group"> <label>Your Story (Max 1000 characters)</label> <textarea id="contentInput" maxlength="1000" placeholder="Share your story anonymously..."></textarea> <div style="text-align: right; font-size: 12px; color: var(--text-secondary); margin-top: 4px;"> <span id="charCount">0</span>/1000 </div> </div>
                <div class="form-group"> <label>Add Image (Optional, Max 5MB)</label> <div class="image-upload"> <label for="cameraInput" class="image-button">📷 Camera</label> <label for="galleryInput" class="image-button">🖼️ Gallery</label> </div> <input type="file" id="cameraInput" accept="image/*" capture="camera" style="display: none;"> <input type="file" id="galleryInput" accept="image/*" style="display: none;"> <div id="imagePreview" class="image-preview" style="display: none;"></div> </div>
                <div class="memorial-toggle"> <input type="checkbox" id="memorialToggle"> <label for="memorialToggle">🕯️ This is a memorial tribute</label> </div>
                <div id="memorialFields" class="memorial-fields" style="display: none;"> <div class="form-group"> <label>Name of the person (optional)</label> <input type="text" id="memorialName" placeholder="Their name..."> </div> <div class="form-group"> <label>Memorial message</label> <textarea id="memorialMessage" placeholder="Share memories..."></textarea> </div> </div>
                <button class="btn" id="postBtn" onclick="createPost()"> <span>🕊️</span> Post Anonymously </button>
            </div>
        </div>
    </div>

    <div id="commentsModal" class="modal">
        <div class="modal-content glassmorphism">
            <div class="modal-header"> <h2>Comments</h2> <button class="modal-close-btn" onclick="closeModal('commentsModal')">&times;</button> </div>
            <div id="commentsContainer"> <div class="loading"> <div class="loading-spinner">💬</div> <p>Loading comments...</p> </div> </div>
            <form id="commentForm" onsubmit="postComment(event)"> <textarea id="commentInput" placeholder="Add a supportive comment..." required></textarea> <button id="postCommentBtn" type="submit" class="btn">Post</button> </form>
        </div>
    </div>

    <div class="bottom-nav glassmorphism">
        <button class="bottom-nav-btn active" data-section="home" onclick="switchSection('home')"> <div>🏠</div> <span>Home</span> </button>
        <button class="bottom-nav-btn" data-section="post" onclick="showModal('postModal')"> <div>➕</div> <span>Post</span> </button> <button class="bottom-nav-btn" data-section="helplines" onclick="switchSection('helplines')"> <div>📞</div> <span>Help</span> </button>
        <button class="bottom-nav-btn" data-section="profile" onclick="switchSection('profile')"> <div>👤</div> <span>Profile</span> </button> </div>

    <div id="toast" class="toast"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script>
        // ================================
        // SUPABASE CONFIG (v14.1 - Use Correct Keys)
        // ================================
        // Using keys from SUPABASE_CREDENTIALS.txt
        const SUPABASE_URL = 'https://jjfkwkmdvpxzjzbblodz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpqZmt3a21kdnB4emp6YmJsb2R6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mjk0NzAwOTQsImV4cCI6MjA0NTA0NjA5NH0.rN8oDm5T_JXOG8KN_wBKiBdVTsE7OUOmBBkKJ4VF9TI';

        let supabase; 
        try {
             supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
             console.log("✅ [DEBUG] Supabase client initialized successfully."); 
        } catch (e) {
            console.error("🚨 CRITICAL ERROR: Supabase client initialization failed:", e); 
            document.body.innerHTML = '<div style="color:white; padding: 20px; text-align: center;"><h1>Connection Error</h1><p>Could not connect to the backend service. Please check your internet connection and try refreshing the page.</p></div>';
        }

        // ================================
        // GLOBAL STATE (v14 Variables Added)
        // ================================
        let userFingerprint = localStorage.getItem('userFingerprint') || generateFingerprint();
        localStorage.setItem('userFingerprint', userFingerprint);
        console.log("ℹ️ [DEBUG] User Fingerprint:", userFingerprint); 
        
        let currentFilter = 'all';
        let selectedImageFile = null; // v14: Store file object
        let currentPostIdForComments = null; 
        let realtimeChannel = null; 

        function generateFingerprint() {
            console.log("⚙️ [DEBUG] Generating new user fingerprint."); 
            return 'user_' + Math.random().toString(36).substring(2) + Date.now().toString(36);
        }

        // ================================
        // INITIALIZE APP (v14.1 - Rebuilt Logic)
        // ================================
        window.addEventListener('load', async function() {
            console.log('🚀 [DEBUG] SafeVoice v14.1.0 - Rebuilt on v13.0 Initializing...'); 
            
            if (!supabase) {
                showToast("🔴 Critical Error: Backend connection failed.");
                 console.error("🚨 [DEBUG] Supabase client not available. Aborting initialization."); 
                return; 
            }
            
            console.log('✅ [DEBUG] Supabase connection confirmed in load event.'); 

            try {
                console.log("⏳ [DEBUG] STEP 1.1: Starting initial loadPosts..."); 
                await loadPosts();
                console.log("✅ [DEBUG] STEP 1.1: Initial loadPosts completed."); 
                
                console.log("⏳ [DEBUG] STEP 1.2: Starting initial fetchAndSetStats..."); 
                await fetchAndSetStats(); 
                console.log("✅ [DEBUG] STEP 1.2: Initial fetchAndSetStats completed."); 

                console.log("⏳ [DEBUG] STEP 2.1: Adding event listeners..."); 
                setupEventListeners(); 
                console.log("✅ [DEBUG] STEP 2.1: Event listeners added."); 
                
                console.log("⏳ [DEBUG] STEP 2.2: Setting up real-time subscription..."); 
                subscribeToChanges(); 
                console.log("✅ [DEBUG] STEP 2.2: Real-time setup initiated."); 

                console.log("✅✅✅ [DEBUG] App initialization sequence fully completed."); 

            } catch (initError) {
                 console.error("🚨🚨🚨 [DEBUG] CRITICAL ERROR during app initialization:", initError); 
                 showToast("❌ App failed to initialize. Please refresh.");
                 const container = document.getElementById('postsContainer') || document.getElementById('memorialsContainer');
                  if(container && container.innerHTML.includes('loading-spinner')) {
                      container.innerHTML = \`<div class="empty-state"><h3>⚠️ Initialization Failed</h3><p>Could not load initial data. Please check console (F12) and refresh.</p><p style="font-size:10px; color:var(--danger);">(\${escapeHtml(initError.message)})</p></div>\`;
                  }
            }
        });
        
        function setupEventListeners() {
             try {
                 const contentInput = document.getElementById('contentInput');
                 const memorialToggle = document.getElementById('memorialToggle');
                 const cameraInput = document.getElementById('cameraInput');
                 const galleryInput = document.getElementById('galleryInput');

                 if (contentInput) contentInput.addEventListener('input', updateCharCount);
                 else console.warn("⚠️ [DEBUG] contentInput not found for listener.");

                 if (memorialToggle) memorialToggle.addEventListener('change', toggleMemorialFields);
                 else console.warn("⚠️ [DEBUG] memorialToggle not found for listener.");

                 if (cameraInput) cameraInput.addEventListener('change', handleImageSelect);
                 else console.warn("⚠️ [DEBUG] cameraInput not found for listener.");

                 if (galleryInput) galleryInput.addEventListener('change', handleImageSelect);
                 else console.warn("⚠️ [DEBUG] galleryInput not found for listener.");

            } catch(e) {
                console.error("🚨 [DEBUG] Error setting up listeners:", e); 
            }
        }
        
        // ================================
        // REAL-TIME (v14 Logic - Single Subscription)
        // ================================
        function subscribeToChanges() {
            if (realtimeChannel || !supabase) {
                 console.log(\`ℹ️ [DEBUG] Skipping real-time setup: channelExists=\${!!realtimeChannel}, supabaseExists=\${!!supabase}\`); 
                 return; 
            }

            try {
                console.log("⏳ [DEBUG] Attempting to create real-time channel 'public-posts'..."); 
                realtimeChannel = supabase
                    .channel('public-posts')
                    .on('postgres_changes', 
                        { event: 'INSERT', schema: 'public', table: 'posts' },
                        async (payload) => { 
                            console.log('➡️ Real-time: New post received!', payload.new); 
                            try { await loadPosts(); await fetchAndSetStats(); } 
                            catch (e) { console.error("🚨 [DEBUG] Real-time Error handling new post:", e); }
                        }
                    )
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'comments' },
                        async (payload) => { 
                             console.log('➡️ Real-time: New comment received!', payload.new); 
                            if (document.getElementById('commentsModal').classList.contains('active') && payload.new.post_id === currentPostIdForComments) {
                                console.log("🔄 [DEBUG] Refreshing comments modal due to real-time event."); 
                                try { await loadComments(currentPostIdForComments); } 
                                catch (e) { console.error("🚨 [DEBUG] Real-time Error handling new comment:", e); }
                            }
                        }
                    )
                    .subscribe((status, err) => {
                         console.log(\`ℹ️ [DEBUG] Real-time status change: \${status}\`); 
                        if (status === 'SUBSCRIBED') { console.log('✅ [DEBUG] Real-time channel subscribed successfully!'); }
                        if (status === 'CHANNEL_ERROR' || status === 'TIMED_OUT' || status === 'CLOSED') { console.error('🚨 [DEBUG] Real-time subscription error/closed:', status, err); showToast("⚠️ Real-time connection issue."); realtimeChannel = null; }
                        if (err) { console.error('🚨 [DEBUG] Real-time subscription error object:', err); }
                    });
            } catch (e) {
                 console.error("🚨 CRITICAL ERROR subscribing to real-time changes:", e); 
                 showToast("❌ Error setting up real-time updates.");
            }
        }

        // ================================
        // NAVIGATION (v14 Logic - Handles Profile)
        // ================================
        function switchSection(section) {
             console.log(\`🔄 [DEBUG] Switching to section: \${section}\`); 
            try {
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                const activeSection = document.getElementById(section);
                if(activeSection) { activeSection.classList.add('active'); console.log(\`✅ [DEBUG] Section '\${section}' activated.\`); } 
                else { console.error(\`🚨 [DEBUG] Section with ID "\${section}" not found. Defaulting to home.\`); const homeSection = document.getElementById('home'); if(homeSection) homeSection.classList.add('active'); section = 'home'; }

                // Update nav buttons based on data-section attribute
                document.querySelectorAll('.nav-btn, .bottom-nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.section === section) { btn.classList.add('active'); }
                });

                if (section === 'home') { filterPosts(null, 'all'); } 
                else if (section === 'memorials') { filterPosts(null, 'memorial'); } 
                else if (section === 'profile') { loadProfile(); }
            } catch (error) { console.error("🚨 [DEBUG] Error in switchSection:", error); showToast("❌ Navigation Error"); }
        }
        
        function showModal(modalId) {
             console.log(\`🔼 [DEBUG] Showing modal: \${modalId}\`); 
             try { const modal = document.getElementById(modalId); if (modal) { modal.classList.add('active'); } else { console.error(\`🚨 [DEBUG] Modal with ID "\${modalId}" not found.\`); } } 
             catch (error) { console.error("🚨 [DEBUG] Error showing modal:", error); showToast("❌ UI Error"); }
        }
        
        function closeModal(modalId) {
             console.log(\`🔽 [DEBUG] Closing modal: \${modalId}\`); 
            try { const modal = document.getElementById(modalId); if (modal) { modal.classList.remove('active'); } else { console.error(\`🚨 [DEBUG] Modal with ID "\${modalId}" not found.\`); } } 
            catch (error) { console.error("🚨 [DEBUG] Error closing modal:", error); showToast("❌ UI Error"); }
        }

        // ================================
        // IMAGE HANDLING (v14 Logic - Use File Object)
        // ================================
        function handleImageSelect(e) {
            console.log("⚙️ [DEBUG] Handling image selection..."); 
            try {
                const file = e.target.files[0];
                if (!file) { console.log("ℹ️ [DEBUG] No file selected."); return; }
                 console.log(\`ℹ️ [DEBUG] File selected: \${file.name}, Size: \${file.size}, Type: \${file.type}\`); 

                if (file.size > 5 * 1024 * 1024) { showToast('❌ Image too large! Max 5MB.'); resetImageInputs(); return; }
                if (!file.type.startsWith('image/')) { showToast('❌ Only image files are allowed.'); resetImageInputs(); return; }

                selectedImageFile = file; // Store file object

                const reader = new FileReader();
                reader.onload = function(event) { console.log("✅ [DEBUG] FileReader loaded successfully."); displayImagePreview(event.target.result); };
                 reader.onerror = function(error) { console.error("🚨 [DEBUG] FileReader error:", error); showToast("❌ Error reading image file."); removeImage(); };
                reader.readAsDataURL(file);
            } catch (error) { console.error("🚨 [DEBUG] Error handling image selection:", error); showToast("❌ Error selecting image."); removeImage(); }
        }

        function displayImagePreview(imageData) {
            console.log("🖼️ [DEBUG] Displaying image preview..."); 
            try { const preview = document.getElementById('imagePreview'); if (!preview) return console.error("🚨 [DEBUG] Image preview element not found!"); preview.style.display = 'block'; preview.innerHTML = \`<img src="\${imageData}" alt="Preview"><button class="remove-image" onclick="removeImage()">×</button>\`; } 
            catch(e) { console.error("🚨 [DEBUG] Error displaying image preview:", e); showToast("❌ Could not display image preview."); }
        }

        function removeImage() {
             console.log("🗑️ [DEBUG] Removing selected image."); 
            try { selectedImageFile = null; const preview = document.getElementById('imagePreview'); if (preview) { preview.style.display = 'none'; preview.innerHTML = ''; } resetImageInputs(); } 
            catch (e) { console.error("🚨 [DEBUG] Error removing image:", e); }
        }
        
        function resetImageInputs() {
            try { const camInput = document.getElementById('cameraInput'); const galInput = document.getElementById('galleryInput'); if (camInput) camInput.value = ''; if (galInput) galInput.value = ''; console.log("ℹ️ [DEBUG] Image input fields reset."); } 
            catch (e) { console.error("🚨 [DEBUG] Error resetting image inputs:", e); }
        }

        // ================================
        // POST FORM HELPERS (v14: Check Elements Exist)
        // ================================
        function updateCharCount() {
             try { const contentInput = document.getElementById('contentInput'); const charCount = document.getElementById('charCount'); if (contentInput && charCount) { charCount.textContent = contentInput.value.length; } else { console.warn("⚠️ [DEBUG] Could not find elements for char count update."); } } 
             catch(e) { console.error("🚨 [DEBUG] Error updating char count:", e); }
        }

        function toggleMemorialFields() {
             try { const memorialToggle = document.getElementById('memorialToggle'); const memorialFields = document.getElementById('memorialFields'); if (memorialToggle && memorialFields) { memorialFields.style.display = memorialToggle.checked ? 'block' : 'none'; } else { console.warn("⚠️ [DEBUG] Could not find elements for memorial toggle."); } } 
             catch(e) { console.error("🚨 [DEBUG] Error toggling memorial fields:", e); }
        }

        // ================================
        // CREATE POST (v14 Logic - Use Storage)
        // ================================
        async function createPost() {
            console.log("⏳ [DEBUG] Attempting to create post..."); 
            if (!supabase) return showToast("🔴 Backend connection error.");

            const college = document.getElementById('collegeInput')?.value.trim();
            const category = document.getElementById('categorySelect')?.value;
            const content = document.getElementById('contentInput')?.value.trim();
            const isMemorial = document.getElementById('memorialToggle')?.checked;
            const memorialName = document.getElementById('memorialName')?.value.trim();
            const memorialMessage = document.getElementById('memorialMessage')?.value.trim();

            if (!college || !content) { showToast('❌ Please fill in college and story'); console.log("🛑 [DEBUG] Post creation failed: Missing college or content."); return; }

            const btn = document.getElementById('postBtn');
            if (!btn) return console.error("🚨 [DEBUG] Post button not found!"); 
            btn.disabled = true; btn.innerHTML = '<span>⏳</span> Posting...';

            try {
                let imageUrl = null;
                if (selectedImageFile) {
                    const fileName = \`\${userFingerprint}_\${Date.now()}_\${selectedImageFile.name.replace(/[^a-zA-Z0-9._-]/g, '')}\`; 
                    showToast('Uploading image...'); console.log(\`⏳ [DEBUG] Uploading \${fileName} to post-images bucket...\`); 
                    const { data: uploadData, error: uploadError } = await supabase.storage.from('post-images').upload(fileName, selectedImageFile);
                    if (uploadError) { console.error("🚨 [DEBUG] Supabase storage upload error:", uploadError); throw new Error(\`Image upload failed: \${uploadError.message}\`); }
                     console.log("✅ [DEBUG] Image upload successful:", uploadData); 
                    console.log("⏳ [DEBUG] Getting public URL for image..."); 
                    const { data: urlData } = supabase.storage.from('post-images').getPublicUrl(fileName);
                    if (!urlData || !urlData.publicUrl) { console.error("🚨 [DEBUG] Could not get public URL for uploaded image."); throw new Error("Failed to get image URL after upload."); }
                    imageUrl = urlData.publicUrl; console.log("✅ [DEBUG] Image URL obtained:", imageUrl); 
                }

                const postData = {
                    college: college, category: category || 'other', content: content, image_url: imageUrl, // Use image_url
                    is_memorial: !!isMemorial, memorial_name: isMemorial ? memorialName : null, memorial_message: isMemorial ? memorialMessage : null,
                    reaction_support: 0, reaction_helpful: 0, reaction_solidarity: 0, anonymous_id: userFingerprint 
                };
                
                 console.log("⏳ [DEBUG] Inserting post data into Supabase:", postData); 
                const { data, error } = await supabase.from('posts').insert([postData]).select();
                if (error) { console.error("🚨 [DEBUG] Supabase insert post error:", error); throw error; }
                console.log("✅ [DEBUG] Post inserted successfully:", data); 
                
                showToast('✅ Post shared successfully!'); resetPostForm(); closeModal('postModal');

            } catch (error) { console.error("🚨🚨🚨 [DEBUG] CRITICAL ERROR creating post:", error); showToast(\`❌ Error creating post: \${error.message}\`); } 
            finally { if (btn) { btn.disabled = false; btn.innerHTML = '<span>🕊️</span> Post Anonymously'; } }
        }
        
        function resetPostForm() {
            try {
                 console.log("⚙️ [DEBUG] Resetting post form fields."); 
                 const collegeInput = document.getElementById('collegeInput'); const contentInput = document.getElementById('contentInput'); const charCount = document.getElementById('charCount'); const memorialToggle = document.getElementById('memorialToggle'); const memorialFields = document.getElementById('memorialFields'); const memorialName = document.getElementById('memorialName'); const memorialMessage = document.getElementById('memorialMessage');
                 if (collegeInput) collegeInput.value = ''; if (contentInput) contentInput.value = ''; if (charCount) charCount.textContent = '0'; if (memorialToggle) memorialToggle.checked = false; if (memorialFields) memorialFields.style.display = 'none'; if (memorialName) memorialName.value = ''; if (memorialMessage) memorialMessage.value = '';
                 removeImage(); 
            } catch (e) { console.error("🚨 [DEBUG] Error resetting post form:", e); }
        }

        // ================================
        // LOAD POSTS (v14.1 - Rebuilt Logic)
        // ================================
        async function loadPosts() {
            if (!supabase) { console.error("🚨 [DEBUG] loadPosts aborted: Supabase client not available."); const container = document.getElementById('postsContainer') || document.getElementById('memorialsContainer'); if(container) container.innerHTML = '<div class="empty-state"><h3>⚠️ Connection Error</h3><p>Cannot load posts. Backend connection failed.</p></div>'; return Promise.reject(new Error("Supabase client not available.")); }
            
            console.log(\`⏳ [DEBUG] [loadPosts] Starting load with filter: \${currentFilter}\`); 
            const containerId = (currentFilter === 'memorial') ? 'memorialsContainer' : 'postsContainer';
            const container = document.getElementById(containerId);
            if (!container) { console.error(\`🚨 [DEBUG] [loadPosts] Container with ID '\${containerId}' not found!\`); return Promise.reject(new Error(\`Container '\${containerId}' not found.\`)); }
            
            let loadingMessage = (currentFilter === 'memorial') ? 'Loading memorials...' : 'Loading posts...'; let loadingIcon = (currentFilter === 'memorial') ? '🕯️' : '🕊️';
            container.innerHTML = \`<div class="loading"><div class="loading-spinner">\${loadingIcon}</div><p>\${loadingMessage}</p></div>\`;

            try {
                let query = supabase.from('posts').select('*').order('timestamp', { ascending: false });
                if (currentFilter === 'all') { query = query.eq('is_memorial', false); } 
                else if (currentFilter === 'memorial') { query = query.eq('is_memorial', true); } 
                else { query = query.eq('category', currentFilter).eq('is_memorial', false); }

                console.log("⏳ [DEBUG] [loadPosts] Executing Supabase query..."); 
                const { data: posts, error } = await query;
                if (error) { console.error("🚨 [DEBUG] [loadPosts] Supabase query error:", error); throw error; }
                 console.log(\`✅ [DEBUG] [loadPosts] Fetched \${posts ? posts.length : 0} posts.\`); 

                if (!posts || posts.length === 0) {
                     console.log("ℹ️ [DEBUG] [loadPosts] No posts found for this filter."); 
                    let emptyIcon = (currentFilter === 'memorial') ? '🕯️' : '🕊️'; let emptyTitle = (currentFilter === 'memorial') ? 'No memorials yet' : 'No posts yet'; let emptyMessage = (currentFilter === 'memorial') ? 'Honor someone by creating a tribute' : 'Be the first to share your voice!';
                    container.innerHTML = \`<div class="empty-state"><div class="empty-state-icon">\${emptyIcon}</div><h3>\${emptyTitle}</h3><p>\${emptyMessage}</p></div>\`;
                    return Promise.resolve(); 
                }
                
                 console.log("⏳ [DEBUG] [loadPosts] Rendering fetched posts..."); 
                if (document.body.contains(container)) { 
                    const renderedPostsHtml = posts.map((post, index) => {
                         try { return renderPost(post); } 
                         catch (renderError) { console.error(\`🚨 [DEBUG] [loadPosts] Error rendering post index \${index}, ID: \${post ? post.id : 'unknown'}:\`, renderError, post); return \`<div class="post-card glassmorphism render-error">Failed to render this post (ID: \${post ? post.id : 'unknown'}). See console.</div>\`; }
                    }).join('');
                    container.innerHTML = renderedPostsHtml; 
                    console.log("⏳ [DEBUG] [loadPosts] Checking and applying reacted status..."); 
                    posts.forEach(post => { if (post && post.id) { checkReactedStatus(post.id); } });
                     console.log("✅ [DEBUG] [loadPosts] Post rendering and reaction checks complete."); 
                     return Promise.resolve(); 
                } else { console.warn("🚨 [DEBUG] [loadPosts] Container was removed before rendering posts could complete."); return Promise.reject(new Error("Container removed during rendering.")); }

            } catch (error) { 
                console.error("🚨🚨🚨 [DEBUG] CRITICAL ERROR in loadPosts catch block:", error); 
                 if (document.body.contains(container)) { container.innerHTML = \`<div class="empty-state"><div class="empty-state-icon">⚠️</div><h3>Error loading posts</h3><p>Could not fetch data. Please refresh.</p><p style="font-size: 10px; color: var(--danger);">(\${escapeHtml(error.message)})</p></div>\`; }
                 return Promise.reject(error); 
            }
        }


        // ================================
        // RENDER POST (v14.1 - Rebuilt Logic)
        // ================================
        function renderPost(post) {
             if (!post || typeof post.id === 'undefined' || typeof post.college === 'undefined' || typeof post.content === 'undefined') { console.error("🚨 [DEBUG] [renderPost] Invalid or incomplete post data received:", post); return '<div class="post-card glassmorphism render-error">Error: Invalid post data. Cannot render.</div>'; }
            
            try { 
                const timeAgo = getTimeAgo(new Date(post.timestamp || Date.now()));
                const category = post.category || 'other';
                const badgeClass = post.is_memorial ? 'memorial' : category;

                const imageHtml = post.image_url ? \`<div class="post-image"><img src="\${escapeHtml(post.image_url)}" alt="Post image" loading="lazy" onerror="this.style.display='none'; console.warn('⚠️ [DEBUG] Image failed to load:', this.src);"></div>\` : '';
                const memorialHtml = post.is_memorial && (post.memorial_name || post.memorial_message) ? \`<div class="memorial-tribute"><h4>🕯️ In Memory \${post.memorial_name ? 'of ' + escapeHtml(post.memorial_name) : ''}</h4>\${post.memorial_message ? \`<p>\${escapeHtml(post.memorial_message)}</p>\` : ''}</div>\` : '';

                const supportCount = Number(post.reaction_support) || 0; const helpfulCount = Number(post.reaction_helpful) || 0; const solidarityCount = Number(post.reaction_solidarity) || 0;
                const postIdStringLiteral = JSON.stringify(post.id); 

                console.log(\`[DEBUG] renderPost Variables for ID \${post.id}:\`, { postId: post.id, college: post.college, timeAgo: timeAgo, badgeClass: badgeClass, category: category, contentLength: post.content.length, imageHtmlExists: !!imageHtml, memorialHtmlExists: !!memorialHtml, supportCount: supportCount, helpfulCount: helpfulCount, solidarityCount: solidarityCount });

                const reactionButtonsHtml = \`
                    <button class="reaction-btn" data-postid="\${escapeHtml(post.id)}" data-type="support" onclick='react(event, \${postIdStringLiteral}, "support")'><span>💚</span><span class="reaction-count">\${supportCount}</span></button>
                    <button class="reaction-btn" data-postid="\${escapeHtml(post.id)}" data-type="helpful" onclick='react(event, \${postIdStringLiteral}, "helpful")'><span>🙌</span><span class="reaction-count">\${helpfulCount}</span></button>
                    <button class="reaction-btn" data-postid="\${escapeHtml(post.id)}" data-type="solidarity" onclick='react(event, \${postIdStringLiteral}, "solidarity")'><span>🤝</span><span class="reaction-count">\${solidarityCount}</span></button>
                \`;
                const commentButtonHtml = \`<button class="comment-btn" onclick='showComments(\${postIdStringLiteral})'><span>💬</span> Comments</button>\`;

                return \` 
                    <div class="post-card glassmorphism" id="post-\${escapeHtml(post.id)}">
                        <div class="post-header"><div class="post-meta"><strong>\${escapeHtml(post.college)}</strong><br><span>\${timeAgo}</span></div><span class="post-badge badge-\${badgeClass}">\${post.is_memorial ? '🕯️ Memorial' : getCategoryLabel(category)}</span></div>
                        <div class="post-content">\${escapeHtml(post.content)}</div>
                        \${imageHtml}
                        \${memorialHtml}
                        <div class="post-actions"><div class="reactions">\${reactionButtonsHtml}</div>\${commentButtonHtml}</div>
                    </div>
                \`; 
            } catch (renderError) { console.error(\`🚨 [DEBUG] [renderPost] Unexpected error rendering post ID \${post.id}:\`, renderError, post); return \`<div class="post-card glassmorphism render-error">Failed to render post ID: \${escapeHtml(post.id)}. Check console. (\${escapeHtml(renderError.message)})</div>\`; }
        } 


        // ================================
        // REACTIONS (v14 Logic - Optimistic Update)
        // ================================
        async function react(event, postId, reactionType) {
             console.log(\`👍 [DEBUG] Reacting to post \${postId} with type \${reactionType}\`); 
            if (!supabase) return showToast("🔴 Backend connection error.");
            if(event) event.preventDefault(); 
            const reactionKey = \`reacted_\${postId}_\${reactionType}\`;
            let btn = event?.currentTarget;
            if (!btn || !btn.matches('.reaction-btn')) { console.warn("⚠️ [DEBUG] react() called without valid button event.currentTarget. Fallback selector."); btn = document.querySelector(\`#post-\${postId} button[data-postid="\${postId}"][data-type="\${reactionType}"]\`); if (!btn) { console.error("🚨 [DEBUG] Could not find reaction button!"); showToast("❌ UI Error reacting"); return; } }

            if (localStorage.getItem(reactionKey)) { showToast('ℹ️ You already reacted this way'); console.log("ℹ️ [DEBUG] Reaction blocked: Already reacted (local check)."); return; }
            
            btn.classList.add('reacted'); btn.disabled = true;
            const countSpan = btn.querySelector('.reaction-count'); let currentCount = 0; 
            if (countSpan) { currentCount = parseInt(countSpan.textContent || '0'); if (isNaN(currentCount)) currentCount = 0; countSpan.textContent = currentCount + 1; console.log(\`✅ [DEBUG] Optimistic update: Count changed from \${currentCount} to \${currentCount + 1}\`); } 
            else { console.error("🚨 [DEBUG] Reaction count span not found!"); }
            
            localStorage.setItem(reactionKey, 'true'); localStorage.setItem(\`reacted_total_\${userFingerprint}\`, (parseInt(localStorage.getItem(\`reacted_total_\${userFingerprint}\`)) || 0) + 1);

            try {
                 console.log("⏳ [DEBUG] Calling Supabase RPC 'increment_reaction'..."); 
                const { data, error } = await supabase.rpc('increment_reaction', { p_post_id: postId, p_reaction_type: reactionType, p_user_fingerprint: userFingerprint });
                if (error) { console.error("🚨 [DEBUG] Supabase RPC error (increment_reaction):", error); throw error; }
                console.log("✅ [DEBUG] RPC increment_reaction result:", data); 
                if (data === false) { showToast('ℹ️ Already reacted (server check)'); console.log("ℹ️ [DEBUG] Server indicated already reacted."); } 
                else { showToast('✅ Reaction added!'); fetchAndSetStats().catch(e => console.error("Error refreshing stats after reaction:", e)); }
            } catch (error) {
                console.error("🚨 CRITICAL ERROR adding reaction:", error); showToast('❌ Error adding reaction');
                 console.log("⏪ [DEBUG] Rolling back optimistic reaction update..."); 
                 try { if (btn) { btn.classList.remove('reacted'); btn.disabled = false; if (countSpan) countSpan.textContent = currentCount; } } 
                 catch (uiError) { console.error("🚨 [DEBUG] Error rolling back button UI:", uiError); }
                localStorage.removeItem(reactionKey); localStorage.setItem(\`reacted_total_\${userFingerprint}\`, Math.max(0, (parseInt(localStorage.getItem(\`reacted_total_\${userFingerprint}\`)) || 0) - 1)); 
            }
        }
        
        function checkReactedStatus(postId) {
            try { if (!postId) return; ['support', 'helpful', 'solidarity'].forEach(type => { const reactionKey = \`reacted_\${postId}_\${type}\`; if (localStorage.getItem(reactionKey)) { const btn = document.querySelector(\`#post-\${postId} button[data-postid="\${postId}"][data-type="\${type}"]\`); if (btn) { btn.classList.add('reacted'); btn.disabled = true; } } }); } 
            catch (e) { console.error("🚨 [DEBUG] Error checking reaction status:", e); }
        }

        // ================================
        // FILTER POSTS (v14 Logic - Uses event target or fallback)
        // ================================
        function filterPosts(event, filter) {
             console.log(\`🔄 [DEBUG] Filtering posts by: \${filter}\`); 
            currentFilter = filter;
            try {
                document.querySelectorAll('#postFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
                let targetButton = null;
                if (event && event.target && event.target.matches('.filter-btn')) { targetButton = event.target; } 
                else { const buttons = document.querySelectorAll('#postFilters .filter-btn'); targetButton = Array.from(buttons).find(btn => btn.getAttribute('onclick')?.includes(\`'\${filter}'\`)); }
                if (targetButton) { targetButton.classList.add('active'); } 
                else { console.warn(\`⚠️ [DEBUG] Filter button for '\${filter}' not found.\`); const allFilterBtn = document.querySelector('#postFilters .filter-btn[onclick*="\'all\'"]'); if(allFilterBtn) allFilterBtn.classList.add('active'); }
                loadPosts(); 
            } catch (e) { console.error("🚨 [DEBUG] Error applying filter:", e); showToast("❌ Error applying filter"); }
        }

        // ================================
        // STATS & PROFILE (v14 Logic - Real Queries)
        // ================================
        async function fetchAndSetStats() {
            if (!supabase) { console.error("🚨 [DEBUG] fetchAndSetStats aborted: Supabase client not available."); return Promise.reject(new Error("Supabase client not available.")); } 
            console.log("⏳ [DEBUG] [fetchAndSetStats] Starting fetch..."); 
            try {
                 console.log("⏳ [DEBUG] [fetchAndSetStats] Fetching total posts count..."); 
                const { count: totalPostCount, error: countError } = await supabase.from('posts').select('*', { count: 'exact', head: true }); 
                if (countError) { console.error("🚨 [DEBUG] [fetchAndSetStats] Error fetching total posts count:", countError); throw countError; }
                 try { const el = document.getElementById('totalPosts'); if (el) el.textContent = totalPostCount || 0; } catch(uiErr){ console.error("[DEBUG] Error setting totalPosts UI:", uiErr); }
                 console.log(\`✅ [DEBUG] [fetchAndSetStats] Total Posts: \${totalPostCount}\`); 

                 console.log("⏳ [DEBUG] [fetchAndSetStats] Fetching total memorials count..."); 
                const { count: memorialCount, error: memError } = await supabase.from('posts').select('*', { count: 'exact', head: true }).eq('is_memorial', true);
                if (memError) { console.error("🚨 [DEBUG] [fetchAndSetStats] Error fetching memorials count:", memError); throw memError; }
                 try { const el = document.getElementById('totalMemorials'); if (el) el.textContent = memorialCount || 0; } catch(uiErr){ console.error("[DEBUG] Error setting totalMemorials UI:", uiErr); }
                 console.log(\`✅ [DEBUG] [fetchAndSetStats] Total Memorials: \${memorialCount}\`); 

                 console.log("⏳ [DEBUG] [fetchAndSetStats] Fetching posts for reaction counts..."); 
                const { data: allPostsData, error: postDataError } = await supabase.from('posts').select('reaction_support, reaction_helpful, reaction_solidarity');
                if (postDataError) { console.error("🚨 [DEBUG] [fetchAndSetStats] Error fetching post reaction data:", postDataError); throw postDataError; }
                 console.log(\`✅ [DEBUG] [fetchAndSetStats] Fetched reaction data from \${allPostsData ? allPostsData.length : 0} posts.\`); 
                const totalReactions = (allPostsData || []).reduce((sum, p) => sum + (Number(p.reaction_support) || 0) + (Number(p.reaction_helpful) || 0) + (Number(p.reaction_solidarity) || 0), 0);
                 try { const el = document.getElementById('totalReactions'); if (el) el.textContent = totalReactions || 0; } catch(uiErr){ console.error("[DEBUG] Error setting totalReactions UI:", uiErr); }
                 console.log(\`✅ [DEBUG] [fetchAndSetStats] Total Reactions calculated: \${totalReactions}\`); 
                 
                 console.log("✅ [DEBUG] [fetchAndSetStats] Fetch completed successfully."); 
                 return Promise.resolve(); 
                
            } catch (e) { 
                console.error("🚨🚨🚨 [DEBUG] CRITICAL ERROR loading stats:", e); showToast("❌ Error loading header stats. Check console."); 
                 try { const tp = document.getElementById('totalPosts'); const tr = document.getElementById('totalReactions'); const tm = document.getElementById('totalMemorials'); if(tp) tp.textContent = '⚠️'; if(tr) tr.textContent = '⚠️'; if(tm) tm.textContent = '⚠️'; } 
                 catch (uiError) { console.error("🚨 [DEBUG] Error updating stats UI to error state:", uiError); }
                 return Promise.reject(e); 
            }
        }
        
        async function loadProfile() {
            if (!supabase) return; 
             console.log("⏳ [DEBUG] Loading profile data..."); 
            try { const el = document.getElementById('profileAnonId'); if (el) el.textContent = userFingerprint; else console.warn("⚠️ [DEBUG] profileAnonId element not found."); } 
            catch (e) { console.error("🚨 [DEBUG] Error setting profileAnonId:", e); }
            
            try {
                 console.log("⏳ [DEBUG] Fetching post count for user:", userFingerprint); 
                const { count, error } = await supabase.from('posts').select('*', { count: 'exact', head: true }).eq('anonymous_id', userFingerprint);
                if (error) throw error;
                 console.log(\`✅ [DEBUG] User post count: \${count}\`); 
                 try { const el = document.getElementById('profilePostCount'); if(el) el.textContent = count || 0; else console.warn("⚠️ [DEBUG] profilePostCount element not found."); } 
                 catch(e){console.error("🚨 [DEBUG] Error setting profilePostCount:", e);}
            } catch (error) {
                console.error("🚨 [DEBUG] Error loading post count for profile:", error); 
                 try { const el = document.getElementById('profilePostCount'); if(el) el.textContent = 'Error'; } 
                 catch(e){console.error("🚨 [DEBUG] Error setting profilePostCount to Error:", e);}
            }
            
            const reactionsGiven = localStorage.getItem(\`reacted_total_\${userFingerprint}\`) || 0;
             try { const el = document.getElementById('profileReactionCount'); if(el) el.textContent = reactionsGiven; else console.warn("⚠️ [DEBUG] profileReactionCount element not found."); } 
             catch(e){console.error("🚨 [DEBUG] Error setting profileReactionCount:", e);}
             console.log(\`✅ [DEBUG] User reactions given (local): \${reactionsGiven}\`); 
        }

        // ================================
        // COMMENTS SYSTEM (v14 Logic)
        // ================================
        async function showComments(postId) {
             console.log(\`💬 [DEBUG] Showing comments for post: \${postId}\`); 
            currentPostIdForComments = postId;
             try { const el = document.getElementById('commentsContainer'); if (!el) return console.error("🚨 [DEBUG] Comments container not found!"); el.innerHTML = \`<div class="loading"><div class="loading-spinner">💬</div><p>Loading comments...</p></div>\`; showModal('commentsModal'); await loadComments(postId); } 
             catch (e) { console.error(\`🚨 [DEBUG] Failed to load comments initially for post \${postId}:\`, e); showToast("❌ Error loading comments."); }
        }
        
        async function loadComments(postId) {
             if (!supabase) return Promise.reject("Supabase client not available."); 
             console.log(\`⏳ [DEBUG] Loading comments for post: \${postId}\`); 
            const container = document.getElementById('commentsContainer'); if (!container) { console.error("🚨 [DEBUG] Comments container not found!"); return Promise.reject("Comments container not found."); }

            try {
                 console.log("⏳ [DEBUG] [loadComments] Executing Supabase query..."); 
                const { data: comments, error } = await supabase.from('comments').select('*').eq('post_id', postId).order('created_at', { ascending: true });
                if (error) { console.error("🚨 [DEBUG] [loadComments] Supabase error loading comments:", error); throw error; }
                 console.log(\`✅ [DEBUG] [loadComments] Fetched \${comments ? comments.length : 0} comments.\`); 
                
                if (!comments || comments.length === 0) { console.log("ℹ️ [DEBUG] [loadComments] No comments found."); container.innerHTML = \`<div class="empty-state"><div class="empty-state-icon">💬</div><h3>No comments yet</h3><p>Be the first to add one!</p></div>\`; return Promise.resolve(); }
                
                 console.log("⏳ [DEBUG] [loadComments] Rendering comments..."); 
                 if (document.body.contains(container)) { 
                    const renderedCommentsHtml = comments.map((comment, index) => { try { return renderComment(comment); } catch (renderError) { console.error(\`🚨 [DEBUG] [loadComments] Error rendering comment index \${index}, ID: \${comment ? comment.id : 'unknown'}:\`, renderError, comment); return \`<div class="comment-card render-error">Failed to render comment (ID: \${comment ? comment.id : 'unknown'}).</div>\`; } }).join('');
                    container.innerHTML = renderedCommentsHtml; console.log("✅ [DEBUG] [loadComments] Comments rendered successfully."); return Promise.resolve();
                 } else { console.warn("🚨 [DEBUG] [loadComments] Comments container removed before rendering."); return Promise.reject("Comments container removed during rendering."); }
                
            } catch (error) { console.error("🚨 CRITICAL ERROR in loadComments catch block:", error); if (document.body.contains(container)) { container.innerHTML = \`<div class="empty-state"><h3>⚠️ Error loading comments</h3><p>Could not fetch comments. (\${escapeHtml(error.message)})</p></div>\`; } return Promise.reject(error); }
        }
        
        function renderComment(comment) {
             if (!comment || typeof comment.id === 'undefined' || typeof comment.anonymous_id === 'undefined' || typeof comment.content === 'undefined') { console.error("🚨 [DEBUG] [renderComment] Invalid comment data:", comment); return '<div class="comment-card render-error">Error: Invalid comment data.</div>'; }
            try { const timeAgo = getTimeAgo(new Date(comment.created_at || Date.now())); const anonId = escapeHtml(comment.anonymous_id).substring(0, 8); return \`<div class="comment-card" id="comment-\${comment.id}"><div class="comment-meta"><strong>\${anonId}...</strong> • <span>\${timeAgo}</span></div><div class="comment-content">\${escapeHtml(comment.content)}</div></div>\`; } 
            catch (renderError) { console.error(\`🚨 [DEBUG] [renderComment] Unexpected error rendering comment ID \${comment.id}:\`, renderError, comment); return \`<div class="comment-card render-error">Failed to render comment ID: \${comment.id}.</div>\`; }
        }
        
        async function postComment(event) {
            event.preventDefault(); console.log("⏳ [DEBUG] Attempting to post comment..."); 
            if (!supabase) return showToast("🔴 Backend connection error.");
            const btn = document.getElementById('postCommentBtn'); const input = document.getElementById('commentInput'); if (!btn || !input) return console.error("🚨 [DEBUG] Comment form elements not found!"); 
            const content = input.value.trim(); if (!content || !currentPostIdForComments) { console.log("🛑 [DEBUG] Comment post blocked: No content or post ID."); return; }
            btn.disabled = true; btn.textContent = '...';
            try { console.log(\`⏳ [DEBUG] Posting comment to post \${currentPostIdForComments}\`); const { data, error } = await supabase.from('comments').insert({ post_id: currentPostIdForComments, content: content, anonymous_id: userFingerprint }); if (error) { console.error("🚨 [DEBUG] Supabase error posting comment:", error); throw error; } console.log("✅ [DEBUG] Comment posted successfully:", data); input.value = ''; showToast("✅ Comment added!"); } 
            catch (error) { console.error("🚨 CRITICAL ERROR posting comment:", error); showToast(\`❌ Error posting comment: \${error.message}\`); } 
            finally { if (btn) { btn.disabled = false; btn.textContent = 'Post'; } }
        }

        // ================================
        // HELPER FUNCTIONS (v14.1 - Rebuilt Logic)
        // ================================
        function getCategoryLabel(category) { const labels = { mental: '💭 Mental Health', academic: '📚 Academic', social: '👥 Social', bullying: '🚫 Bullying', other: '💬 Other' }; return labels[category] || '💬 Other'; }

        function getTimeAgo(date) { try { if (!(date instanceof Date) || isNaN(date.getTime())) { return 'a while ago'; } const seconds = Math.floor((new Date() - date) / 1000); if (isNaN(seconds) || seconds < 0) return 'just now'; const intervals = { year: 31536000, month: 2592000, week: 604800, day: 86400, hour: 3600, minute: 60 }; for (const [unit, secondsInUnit] of Object.entries(intervals)) { if (secondsInUnit <= 0) continue; const interval = Math.floor(seconds / secondsInUnit); if (interval >= 1) { return \`\${interval} \${unit}\${interval !== 1 ? 's' : ''} ago\`; } } return 'Just now'; } catch (e) { console.error("🚨 [DEBUG] Error calculating time ago:", e); return 'a while ago'; } }

        function escapeHtml(text) { try { if (typeof text !== 'string') { if (text === null || typeof text === 'undefined') return ''; text = String(text); } const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;', '\`': '&#96;' }; let escapedText = text.replace(/[&<>\"'\`]/g, m => map[m]); return escapedText.replace(/\\r\\n|\\r|\\n|\n/g, '<br>'); } catch(e) { console.error("🚨 [DEBUG] Error escaping HTML:", e); return 'Content display error'; } }

        function showToast(message) { try { console.log(\`🍞 [DEBUG] Toast: \${message}\`); const toast = document.getElementById('toast'); if (!toast) return console.error("🚨 [DEBUG] Toast element not found!"); toast.textContent = message; toast.classList.add('show'); setTimeout(() => { if (document.body.contains(toast)) { toast.classList.remove('show'); } }, 3000); } catch(e) { console.error("🚨 [DEBUG] Error showing toast:", e); } }

        // ================================
        // SERVICE WORKER (Unchanged)
        // ================================
        if ('serviceWorker' in navigator) { console.log("⚙️ [DEBUG] Attempting to register Service Worker..."); navigator.serviceWorker.register('/sw.js').then((registration) => { console.log('✅ [DEBUG] Service Worker registered successfully with scope:', registration.scope); }).catch(err => { console.error('🚨 [DEBUG] Service Worker registration failed:', err); }); } else { console.log("ℹ️ [DEBUG] Service Worker not supported by this browser."); }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
  <title>SafeVoice v14.0 ‚Äî Your Anonymous Voice Matters</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="manifest" href="manifest.json" />
  <style>
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --bg: #0f172a;
      --surface: rgba(30,41,59,0.7);
      --surface-solid: #1e293b;
      --surface-light: #334155;
      --text: #f1f5f9;
      --text-secondary: #94a3b8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: #475569;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      overflow-x: hidden;
      padding-bottom: 100px;
    }
    .container { max-width: 900px; margin: 0 auto; padding: 20px; }
    .card {
      background: var(--surface);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 0 16px rgba(99,102,241,0.35);
      margin-bottom: 16px;
    }
    .header { margin-bottom: 24px; }
    .logo { display:flex; align-items:center; gap:12px; margin-bottom:8px; }
    .logo h1 {
      font-size: 28px; font-weight: 800;
      background: linear-gradient(135deg, var(--primary), #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .tagline { color: var(--text-secondary); font-size: 14px; }
    .stats { display:grid; grid-template-columns: repeat(3,1fr); gap:12px; margin-top:16px; }
    .stat { text-align:center; }
    .stat .value { font-weight: 800; color: var(--primary); font-size: 22px; }
    .stat .label { font-size: 12px; color: var(--text-secondary); }
    .banner {
      margin-bottom: 20px; background: linear-gradient(135deg, #dc2626, #b91c1c);
      border-radius: 12px; padding: 16px; animation: pulse 2s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.92} }
    .banner h3 { color:white; margin-bottom:4px; }
    .banner p { color: rgba(255,255,255,0.85); }
    .banner .call-btn { display:inline-block; margin-top:10px; background:white; color:#b91c1c;
      padding:10px 16px; border-radius:8px; font-weight:700; text-decoration:none; }
    .nav { display:flex; gap:8px; overflow-x:auto; padding-bottom:8px; margin-bottom: 16px; }
    .nav-btn {
      padding: 10px 16px; border-radius: 18px; font-weight: 700; font-size: 14px;
      border:1px solid var(--border); background: var(--surface-solid); color: var(--text);
      cursor: pointer;
    }
    .nav-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
    .section { display:none; }
    .section.active { display:block; }
    label { display:block; margin-bottom:6px; font-size: 13px; color: var(--text-secondary); font-weight: 600; }
    input, select, textarea {
      width:100%; background: var(--surface-solid); border:1px solid var(--border); color: var(--text);
      border-radius:8px; padding:10px 12px; font-size: 14px; font-family: inherit;
    }
    textarea { resize: vertical; min-height: 110px; }
    input:focus, select:focus, textarea:focus { outline:none; border-color: var(--primary); }
    .btn {
      background: linear-gradient(135deg, var(--primary), #8b5cf6); color:white; border:none; border-radius:8px;
      padding: 12px 18px; font-size: 15px; font-weight: 800; cursor:pointer; width:100%; display:flex;
      align-items:center; justify-content:center; gap:8px;
    }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .image-upload { display:flex; gap:10px; margin-top:8px; }
    .image-button {
      flex:1; padding:12px; border-radius:8px; border:2px dashed var(--border); background: var(--surface-light);
      font-weight:700; cursor:pointer; text-align:center;
    }
    .image-button:hover { border-color: var(--primary); background: var(--primary); color:white; }
    .image-preview { margin-top:10px; position:relative; }
    .image-preview img { max-width:100%; border-radius:8px; border:1px solid var(--border); }
    .remove-image {
      position:absolute; top:8px; right:8px; background: var(--danger); color:white; border:none;
      border-radius:50%; width:36px; height:36px; font-size:18px; font-weight: 800; cursor:pointer;
    }
    .filters { display:flex; gap:8px; overflow-x:auto; padding-bottom:8px; margin: 16px 0; }
    .filter-btn {
      padding: 8px 14px; border-radius: 18px; font-weight: 700; font-size: 13px;
      border:1px solid var(--border); background: var(--surface-solid); color: var(--text);
      cursor: pointer; white-space: nowrap;
    }
    .filter-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
    .post-card { background: var(--surface); border:1px solid var(--border); border-radius: 12px; padding: 18px; margin-bottom: 12px; }
    .post-header { display:flex; align-items:flex-start; justify-content:space-between; }
    .post-meta { font-size: 13px; color: var(--text-secondary); }
    .post-meta strong { color: var(--text); font-size: 15px; }
    .post-badge { padding:6px 12px; border-radius: 12px; font-size: 12px; font-weight: 800; }
    .badge-mental { background: #8b5cf6; color:white; }
    .badge-academic { background: #3b82f6; color:white; }
    .badge-social { background: #10b981; color:white; }
    .badge-bullying { background: #ef4444; color:white; }
    .badge-other { background: #6b7280; color:white; }
    .badge-memorial { background: #f59e0b; color:white; }
    .post-content { margin: 12px 0; line-height: 1.8; font-size: 15px; white-space: pre-wrap; word-wrap: break-word; }
    .post-image { margin: 12px 0; border-radius:8px; overflow:hidden; }
    .post-image img { width:100%; display:block; }
    .reactions { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
    .reaction-btn {
      flex: none; padding:10px; background: var(--surface-solid); border:1px solid var(--border);
      border-radius:8px; cursor:pointer; font-size: 18px; display:flex; gap:6px; align-items:center; font-weight: 700;
    }
    .reaction-count { font-size: 14px; }
    .comments { margin-top: 12px; }
    .comment-item { background: var(--surface-light); border: 1px solid var(--border); border-radius:8px; padding:10px; margin-top:8px; }
    .comment-meta { font-size: 12px; color: var(--text-secondary); }
    .loading { text-align:center; color: var(--text-secondary); padding: 40px 0; }
    .empty-state { text-align:center; color: var(--text-secondary); padding: 60px 0; }
    .toast {
      position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
      background: var(--surface); color: var(--text); padding: 14px 22px; border-radius: 12px; border: 1px solid var(--border);
      z-index: 1000; opacity: 0; transition: opacity 0.3s; font-weight: 700; box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }
    .toast.show { opacity: 1; }
    .bottom-nav {
      position: fixed; bottom:0; left:0; right:0; background: var(--surface-solid); border-top:1px solid var(--border);
      display:flex; justify-content:space-around; padding: 10px 0; z-index: 100;
    }
    .bottom-nav-btn { background:none; border:none; color: var(--text-secondary); cursor:pointer; font-size: 22px; display:flex; flex-direction:column; align-items:center; gap:4px; }
    .bottom-nav-btn.active { color: var(--primary); }
    @media (max-width: 640px) {
      .container { padding: 12px; }
      .stats { grid-template-columns: repeat(3,1fr); }
    }
  </style>

</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="card header">
      <div class="logo">
        <span class="logo-icon">üïäÔ∏è</span>
        <div>
          <h1>SafeVoice</h1>
          <p class="tagline">Your anonymous voice matters ‚Ä¢ Powered by community</p>
        </div>
      </div>
      <div class="stats">
        <div class="stat">
          <div class="value" id="totalPosts">0</div>
          <div class="label">Stories Shared</div>
        </div>
        <div class="stat">
          <div class="value" id="totalReactions">0</div>
          <div class="label">Support Given</div>
        </div>
        <div class="stat">
          <div class="value" id="totalComments">0</div>
          <div class="label">Comments</div>
        </div>
      </div>
    </div>

    <!-- Crisis Banner -->
    <div class="banner">
      <h3>Need Help Now?</h3>
      <p>You're not alone. Help is available now.</p>
      <a class="call-btn" href="tel:1860-2662-345">üìû Call 1860-2662-345</a>
    </div>

    <!-- Navigation -->
    <div class="nav">
      <button class="nav-btn active" onclick="switchSection('home', this)">üè† Home</button>
      <button class="nav-btn" onclick="switchSection('helplines', this)">üìû Helplines</button>
      <button class="nav-btn" onclick="switchSection('memorials', this)">üïØÔ∏è Memorials</button>
      <button class="nav-btn" onclick="switchSection('community', this)">üë• Community</button>
    </div>

    <!-- Home Section -->
    <div id="home" class="section active">
      <!-- Post Form -->
      <div class="card">
        <h2 style="margin-bottom: 12px;">Share Anonymously</h2>
        <div class="form-group" style="margin-bottom: 10px;">
          <label>Your College/University</label>
          <input id="collegeInput" placeholder="e.g., IIT Kharagpur" />
        </div>
        <div class="form-group" style="margin-bottom: 10px;">
          <label>Topic</label>
          <select id="topicSelect">
            <option value="mental">üí≠ Mental Health</option>
            <option value="academic">üìö Academic Pressure</option>
            <option value="social">üë• Social Issues</option>
            <option value="bullying">üö´ Bullying/Harassment</option>
            <option value="other">üí¨ Other</option>
          </select>
        </div>
        <div class="form-group" style="margin-bottom: 6px;">
          <label>Your Story (Max 1000 characters)</label>
          <textarea id="contentInput" maxlength="1000" placeholder="Share your story anonymously... Your words matter."></textarea>
          <div style="text-align:right; font-size: 12px; color: var(--text-secondary);">
            <span id="charCount">0</span>/1000
          </div>
        </div>

        <div class="form-group" style="margin-bottom: 10px;">
          <label>Add Image (Optional)</label>
          <div class="image-upload">
            <label class="image-button" for="cameraInput">üì∑ Camera</label>
            <label class="image-button" for="galleryInput">üñºÔ∏è Gallery</label>
          </div>
          <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;" />
          <input type="file" id="galleryInput" accept="image/*" style="display:none;" />
          <div id="imagePreview" class="image-preview" style="display:none;"></div>
        </div>

        <div class="form-group" style="margin-bottom: 10px;">
          <label style="display:flex; align-items:center; gap:10px; cursor:pointer;">
            <input type="checkbox" id="memorialToggle" style="width:18px; height:18px; cursor:pointer;" />
            üïØÔ∏è This is a memorial tribute
          </label>
        </div>
        <div id="memorialFields" style="display:none;">
          <div class="form-group" style="margin-bottom: 10px;">
            <label>Name of the person (optional)</label>
            <input id="memorialName" placeholder="Their name..." />
          </div>
          <div class="form-group" style="margin-bottom: 10px;">
            <label>Memorial message</label>
            <textarea id="memorialMessage" placeholder="Share memories, celebrate their life..."></textarea>
          </div>
        </div>

        <button class="btn" id="postBtn" onclick="createPost()"><span>üïäÔ∏è</span> Post Anonymously</button>
      </div>

      <!-- Filters -->
      <div class="filters">
        <button class="filter-btn active" onclick="filterPosts('all', this)">All Posts</button>
        <button class="filter-btn" onclick="filterPosts('mental', this)">üí≠ Mental Health</button>
        <button class="filter-btn" onclick="filterPosts('academic', this)">üìö Academic</button>
        <button class="filter-btn" onclick="filterPosts('social', this)">üë• Social</button>
        <button class="filter-btn" onclick="filterPosts('bullying', this)">üö´ Bullying</button>
        <button class="filter-btn" onclick="filterPosts('memorial', this)">üïØÔ∏è Memorials</button>
      </div>

      <!-- Posts Container -->
      <div id="postsContainer">
        <div class="loading">
          <div style="font-size: 42px;">üïäÔ∏è</div>
          <p>Loading posts...</p>
        </div>
      </div>
    </div>

    <!-- Helplines Section -->
    <div id="helplines" class="section">
      <div class="card">
        <h2>üÜò Crisis Helplines</h2>
        <div style="margin-top:12px;">
          <div class="post-card">
            <div class="post-header"><span class="post-badge badge-other">üíö Vandrevala Foundation</span></div>
            <p class="post-content">24/7 ‚Ä¢ Mental health support & crisis intervention</p>
            <div class="reactions"><a class="btn" href="tel:1860-2662-345">üìû Call 1860-2662-345</a></div>
          </div>
          <div class="post-card" style="margin-top:10px;">
            <div class="post-header"><span class="post-badge badge-other">üÜò iCall - TISS</span></div>
            <p class="post-content">Mon-Sat ‚Ä¢ 8 AM-10 PM ‚Ä¢ Suicide prevention & counseling</p>
            <div class="reactions"><a class="btn" href="tel:9152987821">üìû Call 9152-987821</a></div>
          </div>
          <div class="post-card" style="margin-top:10px;">
            <div class="post-header"><span class="post-badge badge-other">üß† NIMHANS Helpline</span></div>
            <p class="post-content">Mon-Sat ‚Ä¢ 8 AM-10 PM ‚Ä¢ Professional counseling</p>
            <div class="reactions"><a class="btn" href="tel:08046110007">üìû Call 080-46110007</a></div>
          </div>
          <div class="post-card" style="margin-top:10px;">
            <div class="post-header"><span class="post-badge badge-danger">üö® Emergency Services</span></div>
            <p class="post-content">National Emergency Number ‚Ä¢ 24/7</p>
            <div class="reactions"><a class="btn" href="tel:112">üìû Call 112</a></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Memorials Section -->
    <div id="memorials" class="section">
      <div class="card">
        <h2>üïØÔ∏è In Loving Memory</h2>
        <p class="tagline">Honoring those we've lost ‚Ä¢ Celebrating their lives</p>
      </div>
      <div id="memorialsContainer">
        <div class="loading">
          <div style="font-size: 42px;">üïØÔ∏è</div>
          <p>Loading memorials...</p>
        </div>
      </div>
    </div>

    <!-- Community Section -->
    <div id="community" class="section">
      <div class="card">
        <h2>üë• Community Guidelines</h2>
        <ul style="margin-top:12px; list-style:none;">
          <li style="padding:6px 0;">‚úì Be kind and supportive</li>
          <li style="padding:6px 0;">‚úì Respect others' experiences</li>
          <li style="padding:6px 0;">‚úì No hate speech or bullying</li>
          <li style="padding:6px 0;">‚úì Report harmful content</li>
          <li style="padding:6px 0;">‚úì Seek help if you need it</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- Bottom Navigation -->
  <div class="bottom-nav">
    <button class="bottom-nav-btn active" onclick="switchSection('home', this)"><div>üè†</div><span>Home</span></button>
    <button class="bottom-nav-btn" onclick="switchSection('helplines', this)"><div>üìû</div><span>Help</span></button>
    <button class="bottom-nav-btn" onclick="switchSection('memorials', this)"><div>üïØÔ∏è</div><span>Memorial</span></button>
    <button class="bottom-nav-btn" onclick="switchSection('community', this)"><div>üë•</div><span>Community</span></button>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

  <script>
    // ================================
    // Supabase configuration (SafeVoice - new deployment)
    // ================================
    const SUPABASE_URL = 'https://mrgapvgbtqgwysfjzwoy.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1yZ2FwdmdidHFnd3lzZmp6d295Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA4NTU2OTYsImV4cCI6MjA3NjQzMTY5Nn0.RMPJ9DhGXJL0qWel88vtjczygunMxY-zra1gzZvN8SM';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // Stable anonymous ID
    function getAnonymousId() {
      const key = 'sv_anon_id';
      let val = localStorage.getItem(key);
      if (!val) {
        val = 'anon_' + Math.random().toString(36).slice(2);
        localStorage.setItem(key, val);
      }
      return val;
    }
    const anonymousId = getAnonymousId();

    // ================================
    // Global state
    // ================================
    let currentFilter = 'all';
    let pageLimit = 15;
    let lastCreatedAt = null;
    let selectedImage = null;

    // ================================
    // Navigation
    // ================================
    function switchSection(section, el) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(section).classList.add('active');

      document.querySelectorAll('.nav-btn, .bottom-nav-btn').forEach(btn => btn.classList.remove('active'));
      
      const bottomNavButtons = document.querySelectorAll('.bottom-nav-btn');
      if (section === 'home') bottomNavButtons[0].classList.add('active');
      if (section === 'helplines') bottomNavButtons[1].classList.add('active');
      if (section === 'memorials') bottomNavButtons[2].classList.add('active');
      if (section === 'community') bottomNavButtons[3].classList.add('active');

      const topNavButtons = document.querySelectorAll('.nav-btn');
      if (section === 'home') topNavButtons[0].classList.add('active');
      if (section === 'helplines') topNavButtons[1].classList.add('active');
      if (section === 'memorials') topNavButtons[2].classList.add('active');
      if (section === 'community') topNavButtons[3].classList.add('active');


      if (section === 'home') {
        resetPagination();
        loadPosts();
      } else if (section === 'memorials') {
        loadMemorials();
      }
    }
    function filterPosts(filter, el) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      if (el) el.classList.add('active');
      resetPagination();
      loadPosts();
    }
    function resetPagination() { lastCreatedAt = null; }

    // ================================
    // Image handling - UPDATED FOR Supabase Function via Service Worker
    // ================================
    document.getElementById('cameraInput').addEventListener('change', handleImageSelect);
    document.getElementById('galleryInput').addEventListener('change', handleImageSelect);

    async function handleImageSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      // Basic client-side validation
      if (file.size > 5 * 1024 * 1024) { // 5MB limit
        return showToast('‚ùå Image is too large! Max 5MB.');
      }
      if (!file.type.startsWith('image/')) {
        return showToast('‚ùå Invalid file type. Please select an image.');
      }

      const postBtn = document.getElementById('postBtn');
      postBtn.disabled = true; // Disable posting during upload
      showToast('‚è≥ Uploading image...');

      try {
        // --- NEW MESSAGE-PASSING LOGIC ---
        // Convert file to base64
        const reader = new FileReader();
        reader.readAsDataURL(file);
        await new Promise((resolve, reject) => {
            reader.onload = resolve;
            reader.onerror = reject;
        });
        const base64 = reader.result.split(',')[1];

        // Create message channel for two-way communication
        const messageChannel = new MessageChannel();

        // Listen for response from service worker
        messageChannel.port1.onmessage = (event) => {
          const { success, url, error } = event.data;
          
          if (success) {
            selectedImage = url;  // Store URL globally for post creation
            displayImagePreview(url); // Show the preview
            // Make success message clearer
            showToast('‚úÖ Image uploaded. Click "Post" to finish.'); 
          } else {
            console.error('Upload failed:', error);
            // Make error toast longer and more descriptive
            const toast = document.getElementById('toast');
            toast.textContent = `‚ùå Upload failed: ${error || 'Unknown error'}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 8000); // 8 seconds
            removeImage(); // Clear preview on failure
          }
          postBtn.disabled = false; // Re-enable button *after* response
        };

        // Ensure service worker is ready and has a controller
        await navigator.serviceWorker.ready;
        if (!navigator.serviceWorker.controller) {
            throw new Error("Service worker is not active or controlling the page.");
        }

        // Send upload request to service worker
        navigator.serviceWorker.controller.postMessage(
          {
            type: 'UPLOAD_FILE',
            fileData: base64,
            fileName: file.name,
            mimeType: file.type
          },
          [messageChannel.port2]
        );
        // --- END OF NEW LOGIC ---
      } catch (err) {
        console.error('Upload error:', err);
        // Make error toast longer and more descriptive
        const toast = document.getElementById('toast');
        toast.textContent = `‚ùå Upload failed: ${err.message}`;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 8000); // 8 seconds
        postBtn.disabled = false; // Re-enable on initial error
      }
    }

    function displayImagePreview(url) {
      const preview = document.getElementById('imagePreview');
      preview.style.display = 'block';
      preview.innerHTML = `
        <img src="${url}" alt="Preview">
        <button class="remove-image" onclick="removeImage()">√ó</button>
      `;
    }

    function removeImage() {
      selectedImage = null;
      const preview = document.getElementById('imagePreview');
      preview.style.display = 'none';
      document.getElementById('cameraInput').value = '';
      document.getElementById('galleryInput').value = '';
    }

    // ================================
    // Form helpers
    // ================================
    document.getElementById('contentInput').addEventListener('input', function() {
      document.getElementById('charCount').textContent = this.value.length;
    });
    document.getElementById('memorialToggle').addEventListener('change', function() {
      document.getElementById('memorialFields').style.display = this.checked ? 'block' : 'none';
    });

    // ================================
    // Create post
    // ================================
    async function createPost() {
      const college = document.getElementById('collegeInput').value.trim();
      const topic = document.getElementById('topicSelect').value;
      const contentRaw = document.getElementById('contentInput').value.trim();
      const isMemorial = document.getElementById('memorialToggle').checked;
      const memorialName = document.getElementById('memorialName').value.trim();
      const memorialMessage = document.getElementById('memorialMessage').value.trim();

      if (!college) return showToast('‚ùå Please enter your college name');
      if (!contentRaw) return showToast('‚ùå Please write your story');
      if (contentRaw.length > 1000) return showToast('‚ùå Content exceeds 1000 characters');

      const btn = document.getElementById('postBtn');
      btn.disabled = true; btn.innerHTML = '<span>‚è≥</span> Posting...';

      try {
        let content = contentRaw;
        let finalTopic = topic;
        if (isMemorial) {
          finalTopic = 'memorial';
          if (memorialName) content = `In Memory of ${memorialName}\n\n${content}`;
          if (memorialMessage) content += `\n\n${memorialMessage}`;
        }

        const { error } = await supabase.from('posts').insert([{
          college,
          topic: finalTopic,
          content,
          image_url: selectedImage || null,
          user_wallet: null,
          anonymous_id: anonymousId,
          created_at: new Date().toISOString()
        }]);
        if (error) throw error;

        showToast('‚úÖ Post shared successfully!');
        // Reset form
        document.getElementById('collegeInput').value = '';
        document.getElementById('contentInput').value = '';
        document.getElementById('charCount').textContent = '0';
        document.getElementById('memorialToggle').checked = false;
        document.getElementById('memorialFields').style.display = 'none';
        document.getElementById('memorialName').value = '';
        document.getElementById('memorialMessage').value = '';
        removeImage();

        resetPagination();
        loadPosts();

      } catch (e) {
        console.error('Error creating post:', e);
        showToast('‚ùå Error posting. Please try again.');
      } finally {
        btn.disabled = false; btn.innerHTML = '<span>üïäÔ∏è</span> Post Anonymously';
      }
    }

    // ================================
    // Load posts with pagination
    // ================================
    async function loadPosts(loadMore = false) {
      const container = document.getElementById('postsContainer');
      if (!loadMore) {
        container.innerHTML = `
          <div class="loading"><div style="font-size:42px;">üïäÔ∏è</div><p>Loading posts...</p></div>`;
      }

      try {
        let query = supabase.from('posts').select('*').order('created_at', { ascending: false }).limit(pageLimit);
        if (currentFilter !== 'all') query = query.eq('topic', currentFilter);
        if (lastCreatedAt) query = query.lt('created_at', lastCreatedAt);

        const { data: posts, error } = await query;
        if (error) throw error;
        
        const loadMoreBtn = document.getElementById('loadMoreBtn');
        if (loadMoreBtn) loadMoreBtn.remove();

        if (!posts || posts.length === 0) {
          if (!loadMore) {
            container.innerHTML = `
              <div class="empty-state">
                <div style="font-size:64px; opacity:0.6;">üïäÔ∏è</div>
                <h3 style="color: var(--text); margin-top:6px;">No posts yet</h3>
                <p>Be the first to share your voice!</p>
              </div>`;
          }
          return;
        }

        lastCreatedAt = posts[posts.length - 1].created_at;

        // Get reaction counts and comments counts
        const postIds = posts.map(p => p.id);
        const { data: reactions } = await supabase.from('reactions').select('post_id,type').in('post_id', postIds);
        const { data: comments } = await supabase.from('comments').select('post_id,id').in('post_id', postIds);

        const reactionCounts = {};
        (reactions || []).forEach(r => {
          const pid = r.post_id;
          reactionCounts[pid] ||= { heart:0, support:0, celebrate:0, strong:0, fire:0, sad:0 };
          reactionCounts[pid][r.type] += 1;
        });

        const commentCounts = {};
        (comments || []).forEach(c => {
          const pid = c.post_id;
          commentCounts[pid] ||= 0;
          commentCounts[pid] += 1;
        });

        const html = posts.map(p => renderPost(p, reactionCounts[p.id] || {}, commentCounts[p.id] || 0)).join('');
        if (loadMore) {
          container.insertAdjacentHTML('beforeend', html);
        } else {
          container.innerHTML = html;
        }

        if (posts.length === pageLimit) {
            const btn = document.createElement('button');
            btn.id = 'loadMoreBtn';
            btn.className = 'btn';
            btn.style.marginTop = '12px';
            btn.textContent = '‚¨áÔ∏è Load more';
            btn.onclick = () => loadPosts(true);
            container.parentElement.appendChild(btn);
        }


      } catch (e) {
        console.error('Error loading posts:', e);
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size:64px;">‚ö†Ô∏è</div>
            <h3 style="color: var(--text); margin-top:6px;">Error loading posts</h3>
            <p>Please refresh the page</p>
          </div>`;
      }
    }

    // ================================
    // Render post + comments section
    // ================================
    function getBadge(topic) {
      const map = {
        mental: 'badge-mental', academic: 'badge-academic', social: 'badge-social',
        bullying: 'badge-bullying', other: 'badge-other', memorial: 'badge-memorial'
      };
      return map[topic] || 'badge-other';
    }
    function labelTopic(topic) {
      const labels = {
        mental: 'üí≠ Mental Health', academic: 'üìö Academic', social: 'üë• Social',
        bullying: 'üö´ Bullying', other: 'üí¨ Other', memorial: 'üïØÔ∏è Memorial'
      };
      return labels[topic] || topic;
    }
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div'); div.textContent = text; return div.innerHTML;
    }
    function timeAgo(iso) {
      const date = new Date(iso);
      const seconds = Math.floor((Date.now() - date.getTime()) / 1000);
      const units = [['year',31536000],['month',2592000],['week',604800],['day',86400],['hour',3600],['minute',60]];
      for (const [label, size] of units) {
        const n = Math.floor(seconds / size); if (n >= 1) return `${n} ${label}${n !== 1 ? 's' : ''} ago`;
      }
      return 'Just now';
    }

    function renderPost(post, counts, commentCount) {
      const badge = getBadge(post.topic);
      return `
        <div class="post-card" data-post-id="${post.id}">
          <div class="post-header">
            <div class="post-meta">
              <strong>${escapeHtml(post.college)}</strong><br>
              <span>${timeAgo(post.created_at)}</span>
            </div>
            <span class="post-badge ${badge}">${labelTopic(post.topic)}</span>
          </div>

          <div class="post-content">${escapeHtml(post.content)}</div>

          ${post.image_url ? `
            <div class="post-image"><img src="${post.image_url}" alt="Post image" loading="lazy"></div>
          ` : ''}

          <div class="reactions">
            <button class="reaction-btn" onclick="react('${post.id}','heart')">üíñ <span class="reaction-count" data-type="heart">${counts.heart || 0}</span></button>
            <button class="reaction-btn" onclick="react('${post.id}','support')">üíö <span class="reaction-count" data-type="support">${counts.support ||.0}</span></button>
            <button class="reaction-btn" onclick="react('${post.id}','celebrate')">üéâ <span class="reaction-count" data-type="celebrate">${counts.celebrate || 0}</span></button>
            <button class="reaction-btn" onclick="react('${post.id}','strong')">üí™ <span class="reaction-count" data-type="strong">${counts.strong || 0}</span></button>
            <button class="reaction-btn" onclick="react('${post.id}','fire')">üî• <span class="reaction-count" data-type="fire">${counts.fire || 0}</span></button>
            <button class="reaction-btn" onclick="react('${post.id}','sad')">üòî <span class="reaction-count" data-type="sad">${counts.sad || 0}</span></button>
          </div>

          <div class="comments">
            <div style="display:flex; align-items:center; justify-content:space-between; margin-top:12px;">
              <h4 style="font-size: 15px;">üí¨ Comments <span class="comment-count-display">(${commentCount})</span></h4>
              <button class="reaction-btn" onclick="toggleComments('${post.id}')">Toggle</button>
            </div>
            <div id="comments-${post.id}" style="margin-top:6px; display:none;">
              <div class="loading">Loading comments...</div>
            </div>
            <div class="form-group" style="margin-top:8px;">
              <label>Add a comment (max 500 characters)</label>
              <textarea id="comment-input-${post.id}" maxlength="500" placeholder="Write anonymously..."></textarea>
              <button class="btn" style="margin-top:8px;" onclick="addComment('${post.id}')">üí¨ Add Comment</button>
            </div>
          </div>
        </div>
      `;
    }

    function toggleComments(postId) {
      const box = document.getElementById(`comments-${postId}`);
      if (!box) return;
      const show = box.style.display === 'none' || box.style.display === '';
      box.style.display = show ? 'block' : 'none';
      if (show) loadComments(postId);
    }

    async function loadComments(postId) {
      const list = document.getElementById(`comments-${postId}`);
      if (!list) return;
      try {
        const { data, error } = await supabase
          .from('comments')
          .select('*')
          .eq('post_id', postId)
          .order('created_at', { ascending: true });
        if (error) throw error;

        if (!data || data.length === 0) {
          list.innerHTML = `<div class="comment-item"><div class="comment-meta">No comments yet</div></div>`;
          return;
        }

        list.innerHTML = data.map(c => `
          <div class="comment-item">
            <div class="comment-meta">${timeAgo(c.created_at)}</div>
            <div style="margin-top:6px;">${escapeHtml(c.content)}</div>
          </div>
        `).join('');
      } catch (e) {
        console.error('Error loading comments:', e);
        list.innerHTML = `<div class="comment-item"><div class="comment-meta">Error loading comments</div></div>`;
      }
    }

    async function addComment(postId) {
      const input = document.getElementById(`comment-input-${postId}`);
      if (!input) return;
      const content = input.value.trim();
      if (!content) return showToast('‚ùå Write a comment');
      if (content.length > 500) return showToast('‚ùå Comment too long');

      try {
        const { error } = await supabase.from('comments').insert([{
          post_id: postId,
          content,
          user_wallet: null,
          anonymous_id: anonymousId,
          created_at: new Date().toISOString()
        }]);
        if (error) throw error;

        input.value = '';
        showToast('‚úÖ Comment added');
        loadComments(postId);

        // Update comment count
        const postCard = document.querySelector(`.post-card[data-post-id="${postId}"]`);
        if(postCard) {
            const countEl = postCard.querySelector('.comment-count-display');
            const currentCount = parseInt(countEl.textContent.match(/\d+/)[0], 10);
            countEl.textContent = `(${currentCount + 1})`;
        }
        updateStats(0, 0, 1);

      } catch (e) {
        console.error('Error adding comment:', e);
        showToast('‚ùå Error adding comment');
      }
    }

    // ================================
    // Reactions with dedupe
    // ================================
    async function react(postId, reactionType) {
      const allowed = ['heart','support','celebrate','strong','fire','sad'];
      if (!allowed.includes(reactionType)) return showToast('‚ùå Invalid reaction');

      try {
        // Optimistic UI update
        const card = document.querySelector(`.post-card[data-post-id="${postId}"]`);
        if(card){
            const el = card.querySelector(`.reaction-count[data-type="${reactionType}"]`);
            if(el) {
                el.textContent = parseInt(el.textContent, 10) + 1;
                updateStats(0, 1, 0);
            }
        }


        const { error } = await supabase.from('reactions').insert([{
          post_id: postId,
          type: reactionType,
          user_wallet: null,
          anonymous_id: anonymousId,
          created_at: new Date().toISOString()
        }]);

        if (error) {
          const msg = (error.message || '').toLowerCase();
          
          // Revert optimistic update on error
          if(card){
            const el = card.querySelector(`.reaction-count[data-type="${reactionType}"]`);
            if(el) {
                el.textContent = parseInt(el.textContent, 10) - 1;
                 updateStats(0, -1, 0);
            }
          }

          if (msg.includes('duplicate') || msg.includes('unique')) {
            showToast('‚ÑπÔ∏è You already reacted to this post');
            return;
          }
          console.error(error);
          showToast('‚ùå Error adding reaction');
          return;
        }

        showToast('‚úÖ Reaction added!');

      } catch (e) {
        console.error('Error adding reaction:', e);
        showToast('‚ùå Error adding reaction');
      }
    }
    
    // ================================
    // Memorials
    // ================================
    async function loadMemorials() {
      const container = document.getElementById('memorialsContainer');
      container.innerHTML = `
        <div class="loading"><div style="font-size:42px;">üïØÔ∏è</div><p>Loading memorials...</p></div>`;
      try {
        const { data: posts, error } = await supabase
          .from('posts')
          .select('*')
          .eq('topic', 'memorial')
          .order('created_at', { ascending: false })
          .limit(50);
        if (error) throw error;

        if (!posts || posts.length === 0) {
          container.innerHTML = `
            <div class="empty-state">
              <div style="font-size:64px; opacity:0.6;">üïØÔ∏è</div>
              <h3 style="color: var(--text); margin-top:6px;">No memorials yet</h3>
              <p>Honor someone's memory by creating a tribute</p>
            </div>`;
          return;
        }

        const html = posts.map(p => `
          <div class="post-card">
            <div class="post-header">
              <div class="post-meta">
                <strong>${escapeHtml(p.college)}</strong><br>
                <span>${timeAgo(p.created_at)}</span>
              </div>
              <span class="post-badge badge-memorial">üïØÔ∏è Memorial</span>
            </div>
            <div class="post-content">${escapeHtml(p.content)}</div>
            ${p.image_url ? `<div class="post-image"><img src="${p.image_url}" alt="Post image" loading="lazy"></div>` : ''}
          </div>
        `).join('');
        container.innerHTML = html;
      } catch (e) {
        console.error('Error loading memorials:', e);
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size:64px;">‚ö†Ô∏è</div>
            <h3 style="color: var(--text); margin-top:6px;">Error loading memorials</h3>
            <p>Please refresh the page</p>
          </div>`;
      }
    }

    // ================================
    // Stats
    // ================================
    async function updateGlobalStats() {
        const { count: postsCount, error: postsError } = await supabase.from('posts').select('*', { count: 'exact', head: true });
        const { count: reactionsCount, error: reactionsError } = await supabase.from('reactions').select('*', { count: 'exact', head: true });
        const { count: commentsCount, error: commentsError } = await supabase.from('comments').select('*', { count: 'exact', head: true });

        if(!postsError) document.getElementById('totalPosts').textContent = postsCount;
        if(!reactionsError) document.getElementById('totalReactions').textContent = reactionsCount;
        if(!commentsError) document.getElementById('totalComments').textContent = commentsCount;
    }

    function updateStats(addPosts = 0, addReactions = 0, addComments = 0) {
        const totalPostsEl = document.getElementById('totalPosts');
        const totalReactionsEl = document.getElementById('totalReactions');
        const totalCommentsEl = document.getElementById('totalComments');

        if (addPosts) totalPostsEl.textContent = parseInt(totalPostsEl.textContent, 10) + addPosts;
        if (addReactions) totalReactionsEl.textContent = parseInt(totalReactionsEl.textContent, 10) + addReactions;
        if (addComments) totalCommentsEl.textContent = parseInt(totalCommentsEl.textContent, 10) + addComments;
    }


    // ================================
    // Toast
    // ================================
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ================================
    // Init
    // ================================
    window.addEventListener('load', function() {
      loadPosts();
      updateGlobalStats();
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/sw.js').catch(()=>{});
      }
    });
  </script>
</body>
</html>




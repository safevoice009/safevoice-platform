<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SafeVoice - Decentralized</title>
    <!-- Web3 Libraries -->
    <script src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --bg: #0f172a; --surface: #1e293b;
            --surface-light: #334155; --text: #f1f5f9; --text-secondary: #94a3b8; --success: #10b981;
            --warning: #f59e0b; --danger: #ef4444; --border: #334155; --memorial-gold: #f59e0b;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); line-height: 1.6; overflow-x: hidden; padding-bottom: 90px; }
        .container { max-width: 800px; margin: 0 auto; padding: 20px; }
        .header { background: var(--surface); padding: 24px; border-radius: 16px; margin-bottom: 24px; border: 1px solid var(--border); }
        .logo { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .logo-icon { font-size: 36px; }
        .logo h1 { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, var(--primary), #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .tagline { color: var(--text-secondary); font-size: 14px; margin-top: 4px; }
        .wallet-info { background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 16px; border: 1px solid var(--border); }
        .wallet-info p { font-size: 12px; color: var(--text-secondary); word-break: break-all; margin: 4px 0; }
        .wallet-info strong { font-size: 18px; color: var(--primary); }
        .btn { background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; padding: 16px 32px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 700; width: 100%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; text-decoration: none; }
        .btn.secondary { background: var(--surface-light); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .post-form { background: var(--surface); padding: 24px; border-radius: 16px; margin-bottom: 24px; border: 1px solid var(--border); }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px; color: var(--text-secondary); }
        input, select, textarea { width: 100%; padding: 12px 16px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-size: 15px; font-family: inherit; }
        textarea { resize: vertical; min-height: 120px; }
        .posts-container { display: flex; flex-direction: column; gap: 16px; }
        .post-card { background: var(--surface); padding: 24px; border-radius: 16px; border: 1px solid var(--border); }
        .post-card.memorial { border-color: var(--memorial-gold); }
        .post-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px; }
        .post-meta { font-size: 13px; color: var(--text-secondary); }
        .post-meta strong { color: var(--text); font-size: 15px; }
        .post-badge { padding: 6px 14px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .badge-memorial { background: var(--memorial-gold); color: white; }
        .post-content { margin: 16px 0; line-height: 1.8; font-size: 15px; white-space: pre-wrap; }
        .memorial-tribute { background: rgba(245, 158, 11, 0.1); padding: 16px; border-radius: 8px; border-left: 4px solid var(--memorial-gold); margin-top: 16px; }
        .memorial-tribute p { margin: 0; color: var(--text); }
        .post-footer { border-top: 1px solid var(--border); margin-top: 20px; padding-top: 20px; display: flex; justify-content: space-between; align-items: center; }
        .reactions { display: flex; gap: 10px; }
        .reaction-btn { padding: 10px 14px; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-size: 18px; display: flex; align-items: center; gap: 8px; font-weight: 600; transition: border-color 0.2s; }
        .loading, .empty-state { text-align: center; padding: 60px 20px; color: var(--text-secondary); }
        .wallet-connector { text-align: center; padding: 40px 20px; background: var(--surface); border-radius: 16px; margin-bottom: 24px; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; padding: 12px 0; z-index: 100; }
        .bottom-nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; font-size: 24px; transition: all 0.2s; }
        .bottom-nav-btn span { font-size: 11px; font-weight: 600; }
        .bottom-nav-btn.active { color: var(--primary); }
        .section { display: none; }
        .section.active { display: block; }
        .comments-section { margin-top: 20px; border-top: 1px solid var(--border); padding-top: 20px; display: none; }
        .comments-list { display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto; padding-right: 8px; margin-bottom: 16px; }
        .comment { background: var(--bg); padding: 14px; border-radius: 8px; }
        .comment-meta { font-size: 12px; color: var(--text-secondary); margin-bottom: 6px; }
        .comment-meta strong { color: var(--text); }
        .comment-content { font-size: 14px; }
        .comment-form { margin-top: 16px; }
        .comment-form-actions { display: flex; gap: 10px; margin-top: 8px; }
        .comment-form-actions button { flex: 1; }
        .comment-form textarea { min-height: 40px; height: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">
                <span class="logo-icon">üîó</span>
                <div>
                    <h1>SafeVoice DApp</h1>
                    <p class="tagline">Decentralized & Unstoppable</p>
                </div>
            </div>
            <div id="walletInfo" class="wallet-info" style="display: none;">
                 <p>Connected: <span id="userWalletAddress"></span></p>
                 <p>Anonymous ID: <strong id="userAnonymousId"></strong></p>
                 <p>Balance: <strong id="userSupportPoints">0</strong> SP</p>
            </div>
        </div>

        <div id="walletConnector" class="wallet-connector">
            <!-- This content will be changed dynamically by JavaScript -->
        </div>

        <div id="dappContent" style="display: none;">
            <div id="home" class="section active">
                <div class="post-form">
                    <h2 style="margin-bottom: 20px; font-size: 22px;">Share Anonymously</h2>
                    <div class="form-group">
                        <label>Your College/University</label>
                        <input type="text" id="collegeInput" placeholder="e.g., IIT Kharagpur" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="categorySelect">
                            <option value="mental">üí≠ Mental Health</option>
                            <option value="academic">üìö Academic Pressure</option>
                            <option value="social">üë• Social Issues</option>
                            <option value="bullying">üö´ Bullying/Harassment</option>
                            <option value="other">üí¨ Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Your Story</label>
                        <textarea id="contentInput" placeholder="Share your story..."></textarea>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" id="memorialToggle" onchange="toggleMemorialFields()" style="width: auto; margin-right: 8px;">
                        <label for="memorialToggle" style="display: inline;">üïØÔ∏è This is a memorial tribute</label>
                    </div>
                    <div id="memorialFields" style="display:none;">
                         <div class="form-group">
                            <label>Name of Person (Optional)</label>
                            <input type="text" id="memorialNameInput" placeholder="e.g., Priya Sharma">
                        </div>
                        <div class="form-group">
                            <label>Tribute Message</label>
                            <textarea id="memorialMessageInput" placeholder="A message to remember them..."></textarea>
                        </div>
                    </div>
                    <button class="btn" id="postBtn" onclick="createPost()">
                        <span>üïäÔ∏è</span> Post to the Network (+10 SP)
                    </button>
                </div>
                <div id="postsContainer" class="posts-container"></div>
            </div>

            <div id="memorials" class="section">
                 <h2 style="margin-bottom: 20px; font-size: 22px;">üïØÔ∏è Permanent Memorials</h2>
                 <p style="color: var(--text-secondary); margin-bottom: 24px;">A permanent, decentralized space to honor and remember students we have lost. These tributes live forever on the network.</p>
                 <div id="memorialsContainer" class="posts-container"></div>
            </div>
        </div>
    </div>
    
    <div class="bottom-nav">
        <button class="bottom-nav-btn active" onclick="switchSection('home', this)">
            <div>üè†</div> <span>Home</span>
        </button>
        <button class="bottom-nav-btn" onclick="switchSection('memorials', this)">
            <div>üïØÔ∏è</div> <span>Memorials</span>
        </button>
    </div>

    <script>
        // ================================
        // CONFIG & STATE
        // ================================
        const GEMINI_API_KEY = ''; // IMPORTANT: PASTE YOUR GEMINI API KEY HERE
        const gun = Gun();
        const posts = gun.get('safevoice-dapp-posts-v7');
        const users = gun.get('safevoice-dapp-users-v7');
        let web3Provider, signer, userAddress, userAnonymousId;
        const ADJECTIVES = ['Brave', 'Strong', 'Hopeful', 'Kind', 'Wise', 'Calm', 'Proud', 'Valiant'];
        const NOUNS = ['Panda', 'Tiger', 'Eagle', 'Lion', 'Wolf', 'Bear', 'Fox', 'Hawk'];

        // ================================
        // INITIALIZATION
        // ================================
        document.addEventListener('DOMContentLoaded', () => {
            init();
        });

        function init() {
            if (typeof window.ethereum !== 'undefined') {
                // MetaMask is likely installed (or another wallet)
                const walletConnector = document.getElementById('walletConnector');
                walletConnector.innerHTML = `
                    <h2>Connect Your Wallet</h2>
                    <p>To post and interact, connect your Web3 wallet.</p>
                    <button class="btn" onclick="connectWallet()" style="margin-top: 20px; width: auto;">Connect Wallet</button>
                `;
            } else {
                // MetaMask is not installed, provide a deep link for mobile
                const walletConnector = document.getElementById('walletConnector');
                const dappUrl = window.location.href;
                const metamaskLink = `https://metamask.app.link/dapp/${dappUrl.replace(/https?:\/\//, '')}`;
                walletConnector.innerHTML = `
                    <h2>MetaMask Not Detected</h2>
                    <p>Please open this page in your MetaMask app's browser, or tap the button below to launch MetaMask.</p>
                    <a href="${metamaskLink}" class="btn" style="margin-top: 20px; width: auto;">üì± Open in MetaMask App</a>
                `;
            }
        }

        // ================================
        // GEMINI API INTEGRATION
        // ================================
        async function getAICommentSuggestion(postId) {
            if (!GEMINI_API_KEY) {
                return alert("The creator has not configured the AI assistant yet.");
            }
            const button = document.querySelector(`#comments-${postId} .suggest-reply-btn`);
            const textarea = document.querySelector(`#comments-${postId} textarea`);
            button.disabled = true;
            button.innerHTML = '<span>‚ú®</span> Thinking...';
            try {
                posts.get(postId).once(async (post) => {
                    if (!post || !post.content) throw new Error("Post content not found.");
                    const systemPrompt = "You are a compassionate friend. Read the following anonymous post from a student and write a short, empathetic, and supportive comment (under 50 words) that they could post in reply. Do not use hashtags. Be encouraging but not overly clinical.";
                    const userQuery = `Here is the post: "${post.content}"`;
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${GEMINI_API_KEY}`;
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const result = await response.json();
                    const suggestedText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (suggestedText) {
                        textarea.value = suggestedText.trim();
                    } else {
                        throw new Error("Could not generate a suggestion.");
                    }
                });
            } catch (error) {
                console.error("Gemini API Error:", error);
                alert(`AI Assistant Error: ${error.message}`);
            } finally {
                button.disabled = false;
                button.innerHTML = '<span>‚ú®</span> Suggest Reply';
            }
        }

        // ================================
        // CORE APP LOGIC
        // ================================
        async function connectWallet() {
            try {
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                web3Provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = web3Provider.getSigner();
                userAddress = await signer.getAddress();
                userAnonymousId = generateAnonymousId(userAddress);
                document.getElementById('walletConnector').style.display = 'none';
                document.getElementById('dappContent').style.display = 'block';
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('userWalletAddress').innerText = `${userAddress.substring(0, 6)}...${userAddress.substring(userAddress.length - 4)}`;
                document.getElementById('userAnonymousId').innerText = userAnonymousId;
                setupUserListeners();
                switchSection('home', document.querySelector('.bottom-nav-btn.active'));
            } catch (error) {
                console.error("Connection error:", error);
                alert("You must connect your wallet to use the DApp.");
            }
        }

        function switchSection(sectionId, element) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            document.querySelectorAll('.bottom-nav-btn').forEach(btn => btn.classList.remove('active'));
            element.classList.add('active');
            if (sectionId === 'home') loadPosts(false);
            if (sectionId === 'memorials') loadPosts(true);
        }

        function toggleMemorialFields() {
            const isChecked = document.getElementById('memorialToggle').checked;
            document.getElementById('memorialFields').style.display = isChecked ? 'block' : 'none';
            document.getElementById('postBtn').innerHTML = isChecked ? '<span>üïØÔ∏è</span> Create Memorial (+15 SP)' : '<span>üïäÔ∏è</span> Post to the Network (+10 SP)';
        }

        function setupUserListeners() {
            users.get(userAddress).get('supportPoints').on(points => {
                document.getElementById('userSupportPoints').innerText = points || 0;
            });
        }

        function updateUserPoints(amount) {
            const userNode = users.get(userAddress);
            userNode.get('supportPoints').once(currentPoints => {
                userNode.get('supportPoints').put((currentPoints || 0) + amount);
            });
        }

        async function createPost() {
            if (!signer) return alert("Please connect your wallet first.");
            const college = document.getElementById('collegeInput').value.trim();
            const category = document.getElementById('categorySelect').value;
            const content = document.getElementById('contentInput').value.trim();
            const isMemorial = document.getElementById('memorialToggle').checked;
            const memorialName = document.getElementById('memorialNameInput').value.trim();
            const memorialMessage = document.getElementById('memorialMessageInput').value.trim();
            if (!college || !content) return alert('College and story cannot be empty.');
            const btn = document.getElementById('postBtn');
            btn.disabled = true;
            btn.innerHTML = '<span>‚è≥</span> Posting...';
            try {
                const postData = {
                    college, category, content, isMemorial, memorialName, memorialMessage,
                    timestamp: new Date().toISOString(),
                    author: userAddress,
                    authorAnonymousId: userAnonymousId
                };
                posts.set(postData);
                updateUserPoints(isMemorial ? 15 : 10);
                alert(`Post successful! You earned ${isMemorial ? 15 : 10} SP.`);
                document.getElementById('collegeInput').value = '';
                document.getElementById('contentInput').value = '';
                document.getElementById('memorialNameInput').value = '';
                document.getElementById('memorialMessageInput').value = '';
                document.getElementById('memorialToggle').checked = false;
                toggleMemorialFields();
            } catch (error) {
                console.error('Error creating post:', error);
                alert(`Error: ${error.message}`);
            } finally {
                btn.disabled = false;
            }
        }

        async function createComment(event, postId) {
            event.preventDefault();
            if (!userAddress) return alert("Please connect wallet.");
            const form = event.target;
            const textarea = form.querySelector('textarea');
            const content = textarea.value.trim();
            if (!content) return;
            const commentData = {
                content,
                author: userAddress,
                authorAnonymousId: userAnonymousId,
                timestamp: new Date().toISOString()
            };
            posts.get(postId).get('comments').set(commentData);
            updateUserPoints(5);
            textarea.value = '';
        }

        function loadPosts(isMemorial) {
            const containerId = isMemorial ? 'memorialsContainer' : 'postsContainer';
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="loading">üîó Loading from network...</div>`;
            const renderedPosts = new Set();
            let hasPosts = false;
            posts.map().once((post, id) => {
                if (post && post.content && post.isMemorial === isMemorial) {
                    if (!hasPosts) {
                        container.innerHTML = '';
                        hasPosts = true;
                    }
                    if (!renderedPosts.has(id)) {
                        renderedPosts.add(id);
                        const postElement = document.createElement('div');
                        postElement.className = `post-card ${post.isMemorial ? 'memorial' : ''}`;
                        postElement.id = id;
                        postElement.innerHTML = renderPostContent(post, id);
                        container.prepend(postElement);
                        setupReactionListeners(id);
                    }
                }
            });
            setTimeout(() => {
                if (!hasPosts) container.innerHTML = `<div class="empty-state">No ${isMemorial ? 'memorials' : 'posts'} found.</div>`;
            }, 3000);
        }

        function renderPostContent(post, id) {
            let tributeHTML = '';
            if (post.isMemorial) {
                tributeHTML = `<div class="memorial-tribute">
                    <p><strong>In memory of ${escapeHtml(post.memorialName) || 'a beloved student'}</strong></p>
                    <p>${escapeHtml(post.memorialMessage)}</p>
                </div>`;
            }
            return `
                <div class="post-header">
                    <div class="post-meta">
                        <strong>${escapeHtml(post.authorAnonymousId)}</strong> from <strong>${escapeHtml(post.college)}</strong><br>
                        <span>${new Date(post.timestamp).toLocaleString()}</span>
                    </div>
                    <span class="post-badge ${post.isMemorial ? 'badge-memorial' : ''}">${post.isMemorial ? 'üïØÔ∏è Memorial' : escapeHtml(post.category)}</span>
                </div>
                <div class="post-content">${escapeHtml(post.content)}</div>
                ${tributeHTML}
                <div class="post-footer">
                    <div class="reactions">
                        <button class="reaction-btn" onclick="addReaction('${id}', 'support')">üíö <span>0</span></button>
                        <button class="reaction-btn" onclick="addReaction('${id}', 'love')">‚ù§Ô∏è <span>0</span></button>
                        <button class="reaction-btn" onclick="addReaction('${id}', 'collab')">üôå <span>0</span></button>
                    </div>
                    <button class="btn secondary" style="width:auto; padding: 8px 16px;" onclick="toggleComments('${id}')">
                        üí¨ Comments
                    </button>
                </div>
                <div class="comments-section" id="comments-${id}"></div>
            `;
        }

        function toggleComments(postId) {
            const commentsSection = document.getElementById(`comments-${postId}`);
            const isVisible = commentsSection.style.display === 'block';
            commentsSection.style.display = isVisible ? 'none' : 'block';
            if (!isVisible) loadComments(postId);
        }

        function loadComments(postId) {
            const container = document.getElementById(`comments-${postId}`);
            container.innerHTML = `<div class="loading">Loading comments...</div>`;
            const commentsNode = posts.get(postId).get('comments');
            const renderedComments = new Set();
            let hasComments = false;
            const setupCommentForm = () => `<div class="comments-list"></div>
                <form class="comment-form" onsubmit="createComment(event, '${postId}')">
                    <textarea required placeholder="Add a supportive comment..."></textarea>
                    <div class="comment-form-actions">
                        <button type="button" class="btn secondary suggest-reply-btn" onclick="getAICommentSuggestion('${postId}')">‚ú® Suggest Reply</button>
                        <button type="submit" class="btn">Reply (+5 SP)</button>
                    </div>
                </form>`;
            commentsNode.map().on((comment, commentId) => {
                if (comment && comment.content && !renderedComments.has(commentId)) {
                    if (!hasComments) {
                        container.innerHTML = setupCommentForm();
                        hasComments = true;
                    }
                    renderedComments.add(commentId);
                    const list = container.querySelector('.comments-list');
                    const commentEl = document.createElement('div');
                    commentEl.className = 'comment';
                    commentEl.innerHTML = renderComment(comment);
                    list.prepend(commentEl);
                }
            });
            setTimeout(() => {
                if (!hasComments) container.innerHTML = setupCommentForm();
            }, 2000);
        }

        function renderComment(comment) {
            return `<div class="comment-meta">
                        <strong>${escapeHtml(comment.authorAnonymousId)}</strong>
                        <span>‚Ä¢ ${new Date(comment.timestamp).toLocaleString()}</span>
                    </div>
                    <p class="comment-content">${escapeHtml(comment.content)}</p>`;
        }

        async function addReaction(postId, reactionType) {
            if (!userAddress) return alert("Please connect wallet.");
            posts.get(postId).once(post => {
                if (post.author === userAddress) return;
                const reactionNode = posts.get(postId).get('reactions').get(reactionType);
                reactionNode.get(userAddress).once(data => {
                    const isReacting = !data;
                    reactionNode.get(userAddress).put(isReacting);
                    updateUserPoints(isReacting ? 1 : -1);
                });
            });
        }

        function setupReactionListeners(postId) {
            ['support', 'love', 'collab'].forEach(type => {
                const reactionsNode = posts.get(postId).get('reactions').get(type);
                reactionsNode.on(() => {
                    let count = 0, userHasReacted = false;
                    reactionsNode.map().once((data, key) => {
                        if (data) {
                            count++;
                            if (key === userAddress) userHasReacted = true;
                        }
                    });
                    const postElement = document.getElementById(postId);
                    if (!postElement) return;
                    const button = postElement.querySelector(`button[onclick*="'${type}'"]`);
                    if (button) {
                        button.querySelector('span').textContent = count;
                        button.style.borderColor = userHasReacted ? 'var(--primary)' : 'var(--border)';
                    }
                });
            });
        }

        function generateAnonymousId(address) {
            const hash = CryptoJS.SHA256(address).toString();
            const adjIndex = parseInt(hash.substring(0, 5), 16) % ADJECTIVES.length;
            const nounIndex = parseInt(hash.substring(5, 10), 16) % NOUNS.length;
            return `${ADJECTIVES[adjIndex]} ${NOUNS[nounIndex]}`;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const el = document.createElement('div');
            el.innerText = text;
            return el.innerHTML;
        }
    </script>
</body>
</html>

